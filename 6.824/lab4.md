



éå¸¸å¥½ï¼Œè¿™æ˜¯ MIT 6.824 Lab 4 ä¸­è®¾è®¡çš„ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ã€‚

------

## âœ… æ­£ç¡®ç­”æ¡ˆï¼š

> **ç”±è¿å…¥ç»„ï¼ˆç›®æ ‡ç»„ï¼‰çš„ leader ä¸»åŠ¨æ‹‰å–æ•°æ®**

------

## ğŸ“¦ ç®€å•ä¸€å¥è¯ï¼š

> âœ… **"è¿å…¥æ–¹æ‹‰ï¼ˆPullï¼‰ï¼Œä¸æ˜¯è¿å‡ºæ–¹æ¨ï¼ˆPushï¼‰"**

------

## ğŸ§  åŸå› åˆ†æï¼ˆä¸ºä»€ä¹ˆä¸èƒ½è¿å‡ºæ–¹æ¨ï¼Ÿï¼‰

### âœ… ä¸€è‡´æ€§ä¸å®¹é”™è€ƒè™‘ï¼š

1. å¦‚æœç”±è¿å‡ºæ–¹ä¸»åŠ¨æ¨é€ï¼ˆpushï¼‰ï¼š
   - ç›®æ ‡ group ä¸ä¸€å®šå‡†å¤‡å¥½æ¥å—ï¼ˆæ¯”å¦‚è¿˜æ²¡æ›´æ–°é…ç½®ï¼‰
   - RPC å¯èƒ½å¤±è´¥ï¼Œæ•°æ®ä¸¢å¤±é£é™©é«˜
2. å¦‚æœç”±è¿å…¥æ–¹ä¸»åŠ¨æ‹‰ï¼ˆpullï¼‰ï¼š
   - å®ƒå¯ä»¥ç¡®ä¿è‡ªå·±å·²ç»æ›´æ–°åˆ°ç›®æ ‡é…ç½®å· `N`
   - å¯ä»¥æ§åˆ¶æ‹‰å–é¡ºåºï¼ˆä¸èƒ½ä¹±åºï¼‰
   - æ‹‰å®Œä¹‹åï¼Œ**é€šè¿‡ Raft æäº¤ InstallShard æ“ä½œä¿è¯ä¸€è‡´æ€§**
   - æ‹‰å®Œåå‘é€ç¡®è®¤ï¼ˆå¯é€‰ï¼‰å†è®©æºåˆ é™¤æ•°æ®

------

## âœ… å®é™…æµç¨‹ï¼ˆæ¨èåšæ³•ï¼‰ï¼š

å‡è®¾å½“å‰ä¸º `config.Num = 3`ï¼Œshard 4 ä» group 1 è½¬ç§»åˆ° group 2ã€‚

### ğŸ“Œ è¿å…¥ç»„ï¼ˆgroup 2ï¼‰çš„ leader æ‰§è¡Œï¼š

1. æ£€æŸ¥è‡ªå·±é…ç½®æ›´æ–°åˆ° `Num = 3`ï¼Œå‘ç° shard 4 æ˜¯è‡ªå·±è´Ÿè´£
2. æ‰§è¡Œ RPC `FetchShard(gid=1, shard=4, configNum=3)`
3. ä» group 1 çš„ leader æ‹¿åˆ° shard 4 çš„æ•°æ®
4. æ‰§è¡Œ `rf.Start(Op{InstallShard, shard=4, data, configNum})` â†’ å†™å…¥ Raft æ—¥å¿—
5. åº”ç”¨æˆåŠŸåï¼Œshard 4 çš„æ•°æ®å°±å±äº group 2

âœ… æ•´ä¸ªè¿‡ç¨‹æ˜¯ç”± group 2 ä¸»åŠ¨é©±åŠ¨

------

### ğŸ“Œ è¿å‡ºç»„ï¼ˆgroup 1ï¼‰çš„èŒè´£ï¼š

- æ¥æ”¶ `FetchShard` è¯·æ±‚
- è¿”å›ï¼š
  - shard æ•°æ®
  - æœ€åä¸€æ¬¡å†™å…¥çš„ `clientRequestSeqMap`ï¼ˆé˜²æ­¢é‡å¤æ‰§è¡Œï¼‰
- **æš‚æ—¶ä¿ç•™æ•°æ®ï¼Œç›´åˆ°ç¡®è®¤å¯¹æ–¹æˆåŠŸè¿å…¥æˆ–é…ç½®å˜åŒ–å·²å®Œæˆ**ï¼ˆå¯é€‰å®ç°ï¼‰

------

## ğŸ“Œ MIT å®˜æ–¹æµ‹è¯•ä¾èµ–è¿™ä¸ªè¡Œä¸º

- å®ƒä¼šæ‰“ä¹±å¤šä¸ª group çš„é…ç½®æ›´æ–°æ—¶é—´é¡ºåº
- å¦‚æœä½ åšæˆâ€œè¿å‡ºæ–¹ä¸»åŠ¨æ¨â€ï¼Œå¾ˆå®¹æ˜“ï¼š
  - å¯¹æ–¹è¿˜æ²¡æ›´æ–°é…ç½®å°±æ”¶åˆ°äº†æ•°æ®ï¼Œç›´æ¥ä¸¢æ‰
  - æˆ–è€…é‡å¤å‘é€é€ æˆé”™è¯¯çŠ¶æ€
- æ‰€ä»¥åªæœ‰è¿å…¥æ–¹ä¸»åŠ¨æ‹‰æ‰èƒ½ç¡®ä¿é…ç½®ä¸€è‡´æ€§æ—¶æœº + æ‹‰åˆ°æ­£ç¡®æ•°æ®

------

## âœ… æ€»ç»“å¯¹æ¯”

| é¡¹ç›®           | æ‹‰å–æ–¹å¼ï¼ˆâœ… æ¨èï¼‰ | æ¨é€æ–¹å¼ï¼ˆâŒ é”™è¯¯ï¼‰ |
| -------------- | ------------------ | ------------------ |
| ä¸»åŠ¨å‘èµ·       | è¿å…¥ç»„             | è¿å‡ºç»„             |
| æ§åˆ¶é…ç½®ä¸€è‡´æ€§ | âœ… å¯æ§             | âŒ ä¸å¯æ§           |
| å®¹é”™æ€§         | âœ… é«˜               | âŒ å®¹æ˜“ä¸¢æ•°æ®       |
| å®˜æ–¹æµ‹è¯•æ”¯æŒ   | âœ… é€šè¿‡             | âŒ å¯èƒ½å¤±è´¥         |

------

## âœ… å¦‚æœä½ éœ€è¦

æˆ‘å¯ä»¥å¸®ä½ ç”Ÿæˆå¦‚ä¸‹å†…å®¹ï¼š

- `FetchShardArgs/Reply` RPC å®šä¹‰
- `InstallShard` çš„ Raft log æäº¤ç»“æ„
- è¿å…¥æ–¹å®šæ—¶æ£€æŸ¥ + æ‹‰ shard çš„é€»è¾‘æµç¨‹å›¾

æ˜¯å¦è¦æˆ‘å¸®ä½ å†™ä¸€ä»½æ¨¡æ¿ç»“æ„ï¼Ÿåªéœ€å›å¤â€œç»§ç»­â€å³å¯ã€‚





è¿™æ˜¯ä¸€ä¸ª **Go è¯­è¨€ä¸­çš„å…³é”®è®¾è®¡é—®é¢˜**ï¼Œç‰¹åˆ«é€‚ç”¨äºä½ åœ¨ MIT 6.824 ä¸­å¤„ç†å¦‚ `Config` è¿™ç±»ç»“æ„ä½“æ—¶ã€‚ä½ é—®çš„æ˜¯ï¼š

> ğŸ’¡ åœ¨å‡½æ•°å‚æ•°ä¸­ï¼Œä»€ä¹ˆæ—¶å€™åº”è¯¥ä½¿ç”¨æŒ‡é’ˆ `*shardmaster.Config`ï¼Œä»€ä¹ˆæ—¶å€™ç”¨å€¼ `shardmaster.Config`ï¼Ÿ

------

## âœ… æ€»ç»“ä¼˜å…ˆç»“è®ºï¼ˆè®°ä½è¿™æ¡ï¼‰ï¼š

| ä½¿ç”¨æ–¹å¼              | é€‚ç”¨æƒ…å†µ                                         |
| --------------------- | ------------------------------------------------ |
| `*Config`ï¼ˆæŒ‡é’ˆä¼ å‚ï¼‰ | **ç»“æ„ä½“è¾ƒå¤§**ã€**è¦ä¿®æ”¹å­—æ®µ**ã€**é¿å…å¤åˆ¶**     |
| `Config`ï¼ˆå€¼ä¼ å‚ï¼‰    | **ç»“æ„ä½“è¾ƒå°**ã€**åªè¯»è®¿é—®**ã€**ä¸æ‹…å¿ƒå¤åˆ¶æˆæœ¬** |



------

## ğŸ“¦ åº”ç”¨åˆ°ä½ çš„ Lab åœºæ™¯ä¸­ï¼š

### `shardmaster.Config` æ˜¯ä¸ª **è¾ƒå¤§ç»“æ„ä½“**ï¼Œé€šå¸¸åŒ…æ‹¬ï¼š

```
go


å¤åˆ¶ç¼–è¾‘
type Config struct {
    Num    int                  // config number
    Shards [NShards]int         // shard -> gid
    Groups map[int][]string     // gid -> servers[]
}
```

- æœ‰ä¸€ä¸ª `[10]int` æ•°ç»„ï¼ˆå›ºå®šå°ï¼‰
- **ä½†è¿˜åŒ…å« map[int][]string**ï¼ˆå¯èƒ½è¾ƒå¤§ï¼‰

------

## âœ… å› æ­¤æ¨èï¼š

| åœºæ™¯                            | å»ºè®®ä¼ å‚æ–¹å¼              | åŸå›                  |
| ------------------------------- | ------------------------- | -------------------- |
| RPC handler ä¸­åªè¯» config       | `*Config` âœ…               | é¿å…å¤åˆ¶             |
| é€»è¾‘å‡½æ•°åªè¯» configï¼ˆå†…éƒ¨å¤„ç†ï¼‰ | `Config` âœ… æˆ– `*Config` âœ… | éƒ½è¡Œï¼Œä½†ä¼ æŒ‡é’ˆæ›´ä¸€è‡´ |
| éœ€è¦ä¿®æ”¹ Config å¹¶å›ä¼           | `*Config` âœ…               | å¿…é¡»ç”¨æŒ‡é’ˆ           |
| ä¸´æ—¶ç»“æ„ä½“ã€è½»é‡å‡½æ•°            | `Config`                  | å¯ä»¥æ¥å—             |



------

## ğŸ” å¯¹ä½ å‡½æ•°çš„å»ºè®®ï¼š

ä½ å†™çš„æ˜¯ï¼š

```
go


å¤åˆ¶ç¼–è¾‘
func (kv *ShardKV) AskMoveShardsRPC(oldConfig shardmaster.Config, newConfig shardmaster.Config)
```

**å»ºè®®ä½ æ”¹æˆï¼š**

```
go


å¤åˆ¶ç¼–è¾‘
func (kv *ShardKV) AskMoveShardsRPC(oldConfig *shardmaster.Config, newConfig *shardmaster.Config)
```

âœ… åŸå› ï¼š

1. **é¿å…å¤åˆ¶ mapï¼šmap æ˜¯å¼•ç”¨ç±»å‹ï¼Œä½†ç»“æ„ä½“å€¼ä¼ ä¼šå¤åˆ¶ map çš„å­—æ®µæŒ‡é’ˆï¼Œå¢åŠ å¤æ‚åº¦**
2. ä¿æŒä¸€è‡´æ€§ï¼ˆå¤§å¤šæ•°å‡½æ•°éƒ½ç”¨ `*Config`ï¼‰

------

## âœ… è¡¥å……ï¼šRPC ä¸­ä¸€å®šè¦ç”¨æŒ‡é’ˆ

Go çš„ RPC åºåˆ—åŒ–æœºåˆ¶è¦æ±‚ï¼š

- `args` å’Œ `reply` å‚æ•°å¿…é¡»æ˜¯æŒ‡é’ˆ
- æ‰€ä»¥ä½ å®šä¹‰çš„ RPC å‡½æ•°å¿…é¡»æ˜¯ï¼š

```
go


å¤åˆ¶ç¼–è¾‘
func (kv *ShardKV) FetchShard(args *FetchShardArgs, reply *FetchShardReply) error
```

------

## ğŸ§  ä¸€å¥è¯è®°å¿†æ³•ï¼š

> âœ¨ â€œå¤§ç»“æ„ï¼Œç”¨æŒ‡é’ˆï¼›éœ€ä¿®æ”¹ï¼Œç”¨æŒ‡é’ˆï¼›RPCï¼Œå¿…é¡»æŒ‡é’ˆã€‚â€





éå¸¸æ£’çš„é—®é¢˜ï¼è¿™ä¸ªæ˜¯ **Go è¯­è¨€ä¸­æœ€å®¹æ˜“æ··æ·†çš„ç‚¹ä¹‹ä¸€**ã€‚ä½ é—®ï¼š

> Go ä¸­ `Config` æ˜¯ç»“æ„ä½“ï¼Œå€¼ä¼ å‚æ—¶ä¸ºä»€ä¹ˆè¯´ä¼šâ€œå¤åˆ¶â€ï¼Ÿä¸æ˜¯å¼•ç”¨ä¼ é€’å—ï¼Ÿ

------

## âœ… ç²¾å‡†ç­”æ¡ˆï¼š

> åœ¨ **Go ä¸­ï¼Œç»“æ„ä½“å€¼ä¼ å‚ä¼šå¤åˆ¶æ•´ä¸ªç»“æ„ä½“æœ¬èº«**ï¼Œ**ä½†ç»“æ„ä½“ä¸­çš„ mapã€slice å­—æ®µæ˜¯å¼•ç”¨ç±»å‹ï¼Œä¼šâ€œå…±äº«æŒ‡å‘â€**ã€‚

------

## ğŸ¯ ä¸¾ä¾‹è¯´æ˜ï¼š

å‡è®¾ä½ æœ‰è¿™ä¸ªç»“æ„ä½“ï¼š

```go
type Config struct {
    Num    int
    Shards [10]int
    Groups map[int][]string
}
```

### å½“ä½ è¿™æ ·å†™ï¼š

```go
func Foo(c Config) {
    c.Num = 5             // âœ… åªæ”¹äº†å‰¯æœ¬ï¼ŒåŸå§‹ Config ä¸å˜
    c.Groups[1] = nil     // â—ä¼šå½±å“åŸå§‹ Config çš„ mapï¼å› ä¸º map æ˜¯å¼•ç”¨ç±»å‹
}
```

**å…³é”®ç‚¹ï¼š**

| å­—æ®µ     | è¡Œä¸ºï¼ˆå€¼ä¼ å‚æ—¶ï¼‰       | åŸå›                           |
| -------- | ---------------------- | ----------------------------- |
| `Num`    | âœ… æ‹·è´å‰¯æœ¬             | åŸºç¡€ç±»å‹ int                  |
| `Shards` | âœ… æ‹·è´æ•°ç»„å‰¯æœ¬         | å€¼è¯­ä¹‰æ•°ç»„                    |
| `Groups` | â—åªæ‹·è´äº† map çš„â€œå¼•ç”¨â€ | `map[int][]string` æ˜¯å¼•ç”¨ç±»å‹ |

------

## ğŸ“Œ æ‰€ä»¥ä½ è¯¥æ€ä¹ˆç†è§£ï¼Ÿ

### âœ”ï¸ ç»“æ„ä½“ä¼ å€¼ï¼š

- æ˜¯**é€å­—æ®µå¤åˆ¶**
- **map/slice/channel/pointer/function/interface** ç­‰å­—æ®µæœ¬èº«è¢«æ‹·è´ï¼Œä½†å®ƒä»¬æŒ‡å‘çš„åº•å±‚æ•°æ®æ˜¯å…±äº«çš„

------

## ğŸš¨ é—®é¢˜çš„é£é™©

```go
func (kv *ShardKV) AskMoveShardsRPC(oldConfig Config) {
    oldConfig.Groups[3] = nil  // è¿™ä¼šæ”¹å˜åŸå§‹ Config çš„ mapï¼âŒ æ„å¤–å‰¯ä½œç”¨
}
```

çœ‹èµ·æ¥ä½ åœ¨â€œå€¼ä¼ é€’â€ï¼Œä½†å®é™…æ”¹å˜äº†å…±äº«å¼•ç”¨çš„å†…éƒ¨å†…å®¹ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿ bugã€‚

------

## âœ… æ‰€ä»¥å»ºè®®ï¼š

| åœºæ™¯                  | æ¨èæ–¹å¼       | ç†ç”±                           |
| --------------------- | -------------- | ------------------------------ |
| å¤§ç»“æ„ä½“ï¼ˆå¦‚ Configï¼‰ | âœ… æŒ‡é’ˆä¼ å‚     | é¿å…å¤åˆ¶ï¼Œæé«˜æ•ˆç‡ï¼Œè¡Œä¸ºæ›´å¯æ§ |
| å°ç»“æ„ä½“ã€å®Œå…¨åªè¯»    | å€¼ä¼ å‚å¯æ¥å—   | æ²¡å‰¯ä½œç”¨ï¼Œæ€§èƒ½ä¹Ÿå¥½             |
| æƒ³ç¡®ä¿åŸå§‹å€¼ä¸è¢«å½±å“  | å…ˆæ‹·è´ï¼Œå†ä¼ å€¼ | ç”¨ `copy := *oldConfig`        |

------

## âœ… æ€»ç»“è®°å¿†å¥ï¼š

> ğŸ§  â€œç»“æ„ä½“æ˜¯å€¼è¯­ä¹‰ï¼Œå­—æ®µè‹¥æ˜¯å¼•ç”¨å‹ï¼Œå°±ä¼šå…±äº«å¼•ç”¨ â€”â€” æ‰€ä»¥å€¼ä¼ å‚ä¸æ˜¯å…¨å®‰å…¨ã€‚â€

------

å¦‚æœä½ æƒ³æˆ‘æ¼”ç¤ºä¸€æ®µçœŸå®ä»£ç ï¼šç”¨å€¼ä¼ å’Œç”¨æŒ‡é’ˆä¼ æ—¶ `map` è¢«ä¿®æ”¹å¯¼è‡´çš„å‰¯ä½œç”¨ï¼Œæˆ‘å¯ä»¥è´´ä¸€ä¸ªå¯¹æ¯”æ ·ä¾‹ã€‚éœ€è¦å—ï¼Ÿ



# å¦‚ä½•ç†è§£ go çš„å€¼ä¼ é€’

## âœ… ä¸€å¥è¯æ ¸å¿ƒç»“è®ºï¼š

> **Go ä¸­æ‰€æœ‰ä¼ å‚éƒ½æ˜¯â€œå€¼ä¼ é€’â€** â€”â€” ä¸ç®¡ä½ ä¼ çš„æ˜¯å€¼ã€æŒ‡é’ˆã€mapã€sliceã€channel ç­‰ï¼Œä¼ é€’çš„éƒ½æ˜¯â€œå˜é‡çš„å‰¯æœ¬â€ã€‚

------

## ğŸ“¦ å…·ä½“æ¥è®²ï¼š

### åœ¨ Go ä¸­ï¼š

- æ¯æ¬¡**å‡½æ•°è°ƒç”¨éƒ½ä¼šå¤åˆ¶å‚æ•°**
- **å¤åˆ¶çš„æ˜¯å˜é‡çš„å€¼**ï¼Œå¯¹äºä¸åŒç±»å‹ï¼Œè¿™ä¸ªâ€œå€¼â€æœ‰ä¸åŒå«ä¹‰ï¼š

| ç±»å‹                                 | å¤åˆ¶çš„æ˜¯...      | ä¸¾ä¾‹è¯´æ˜                       |
| ------------------------------------ | ---------------- | ------------------------------ |
| åŸºç¡€ç±»å‹ï¼ˆint, bool, stringï¼‰        | å€¼æœ¬èº«           | æ”¹å‰¯æœ¬ä¸ä¼šå½±å“åŸå˜é‡           |
| struct                               | æ•´ä¸ªç»“æ„ä½“å‰¯æœ¬   | æ‰€æœ‰å­—æ®µéƒ½è¢«å¤åˆ¶ï¼ŒåŒ…æ‹¬å¼•ç”¨å­—æ®µ |
| æŒ‡é’ˆ `*T`                            | æŒ‡é’ˆçš„å€¼ï¼ˆåœ°å€ï¼‰ | æ”¹æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹ä¼šå½±å“åŸå§‹å˜é‡ |
| map/slice/channel/function/interface | å¼•ç”¨çš„å‰¯æœ¬       | åº•å±‚æ•°æ®å…±äº«ï¼ŒæŒ‡é’ˆä¸åŒ         |



------

## ğŸ§  ä¸¾ä¾‹ 1ï¼šåŸºç¡€ç±»å‹æ˜¯å€¼å¤åˆ¶

```
go


å¤åˆ¶ç¼–è¾‘
func f(x int) {
    x = 100
}

func main() {
    a := 1
    f(a)
    fmt.Println(a)  // è¾“å‡º 1ï¼Œä¸å˜
}
```

- `x` æ˜¯ `a` çš„å‰¯æœ¬
- æ”¹ `x` ä¸ä¼šå½±å“ `a`

------

## ğŸ§  ä¸¾ä¾‹ 2ï¼šç»“æ„ä½“æ˜¯å€¼å¤åˆ¶ï¼ˆå­—æ®µæ˜¯åŸºç¡€ç±»å‹ï¼‰

```
go


å¤åˆ¶ç¼–è¾‘
type Point struct {
    X int
    Y int
}

func move(p Point) {
    p.X = 100
}

func main() {
    a := Point{1, 2}
    move(a)
    fmt.Println(a.X)  // è¾“å‡º 1ï¼Œä¸å˜
}
```

- `p` æ˜¯ç»“æ„ä½“çš„å‰¯æœ¬
- æ”¹çš„æ˜¯å‰¯æœ¬ä¸­çš„ `X`

------

## ğŸ§  ä¸¾ä¾‹ 3ï¼šç»“æ„ä½“å­—æ®µæ˜¯å¼•ç”¨ç±»å‹ï¼ˆæ¯”å¦‚ mapï¼‰

```
go


å¤åˆ¶ç¼–è¾‘
type Config struct {
    Groups map[int][]string
}

func change(cfg Config) {
    cfg.Groups[1] = nil
}

func main() {
    cfg := Config{Groups: map[int][]string{1: {"a", "b"}}}
    change(cfg)
    fmt.Println(cfg.Groups[1])  // â—å˜æˆ nilï¼Œå€¼è¢«ä¿®æ”¹äº†
}
```

- `cfg` æ˜¯å€¼ä¼ é€’çš„å‰¯æœ¬ï¼Œä½†å…¶ä¸­ `Groups` æ˜¯ **map å¼•ç”¨**
- æ‰€ä»¥å³ä½¿æ˜¯å€¼ä¼ é€’ï¼Œ**åº•å±‚ map è¢«ä¿®æ”¹äº†**

------

## âœ… æ‰€ä»¥çœŸæ­£ç†è§£ Go å€¼ä¼ é€’ï¼Œè¦åŒºåˆ†ï¼š

| ä½ ä¼ çš„æ˜¯                    | è¢«å¤åˆ¶çš„æ˜¯                  | æ˜¯å¦å½±å“åŸå˜é‡               |
| --------------------------- | --------------------------- | ---------------------------- |
| å€¼ç±»å‹ï¼ˆintã€boolã€ç»“æ„ä½“ï¼‰ | å€¼æœ¬èº«                      | âŒ ä¸ä¼šå½±å“                   |
| æŒ‡é’ˆ `*T`                   | æŒ‡é’ˆï¼ˆåœ°å€ï¼‰                | âœ… ä¼šå½±å“                     |
| map / slice / channel       | å¼•ç”¨æŒ‡é’ˆå‰¯æœ¬                | âœ… ä¼šå½±å“åº•å±‚å†…å®¹             |
| interface                   | interface æœ¬èº« + æŒ‡å‘çš„æ•°æ® | âš ï¸ ç‰¹åˆ«æ³¨æ„ï¼šå¯èƒ½æœ‰å¤åˆ¶å‰¯ä½œç”¨ |



------

## âœ… ç»“è®ºå£è¯€ï¼š

> â€œGo æ°¸è¿œæ˜¯å€¼ä¼ é€’ï¼›å¼•ç”¨ç±»å‹å€¼è¢«å¤åˆ¶ï¼Œä½†æŒ‡å‘çš„ä¸œè¥¿å…±äº«ã€‚â€





# å¦‚ä½•èƒ½æƒ³åˆ°æ‰§è¡Œ config çš„æ›´æ–°ä¸æ˜¯åœ¨æœåŠ¡ç«¯çš„ joinï¼Œquery ä¸­ï¼Œè€Œæ˜¯åœ¨ apply ä¸­ï¼Ÿ

è¿™æ˜¯ä¸ª**éå¸¸ä¼˜ç§€çš„é—®é¢˜**ï¼Œè§¦åŠäº†**åˆ†å¸ƒå¼ä¸€è‡´æ€§ç³»ç»Ÿçš„æœ¬è´¨è®¾è®¡å“²å­¦**ã€‚ä½ é—®çš„æ˜¯ï¼š

> ğŸ’¡ ä¸ºä»€ä¹ˆ config çš„æ›´æ–°é€»è¾‘ï¼ˆå¦‚ Joinï¼‰**ä¸åº”è¯¥ç›´æ¥åœ¨ RPC handler é‡Œåš**ï¼Œè€Œæ˜¯åº”è¯¥ç­‰ Raft apply åå†åšï¼Ÿ

------

## âœ… ç®€çŸ­ç›´è§‰å›ç­”ï¼š

å› ä¸ºä½ å†™çš„æ˜¯ **åˆ†å¸ƒå¼å®¹é”™ç³»ç»Ÿï¼ˆä½¿ç”¨ Raftï¼‰**ï¼Œä¸æ˜¯å•æœºä»£ç ï¼Œ
 **æ‰€æœ‰ä¼šæ”¹å˜ç³»ç»ŸçŠ¶æ€çš„æ“ä½œï¼Œéƒ½å¿…é¡»æ˜¯è¢« Raft å…±è¯†ç¡®è®¤è¿‡çš„æ“ä½œï¼Œæ‰èƒ½çœŸæ­£æ‰§è¡Œã€‚**

RPC handler ä¸­åªæ˜¯â€œæ„å›¾â€çš„è¡¨è¾¾ï¼Œ
 çœŸæ­£èƒ½å½±å“ç³»ç»ŸçŠ¶æ€çš„æ“ä½œï¼Œ**åªèƒ½æ˜¯ Raft æ—¥å¿—è¢«æäº¤å¹¶ apply ä¹‹åçš„é‚£ä¸€åˆ»**ã€‚

------

## ğŸ§  æ›´æ·±å…¥ï¼šä¸ºä»€ä¹ˆå¿…é¡»åœ¨ apply ä¸­å¤„ç† config æ›´æ–°ï¼Ÿ

### ğŸš© åŸå›  1ï¼š**Raft æ˜¯çŠ¶æ€æœºå¤åˆ¶åè®®**

Raft çš„æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼š

> â€œè®©å¤šä¸ªå‰¯æœ¬éƒ½ä»¥**å®Œå…¨ç›¸åŒçš„é¡ºåº**æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä»è€Œè¾¾åˆ°ä¸€è‡´â€ã€‚

æ‰€ä»¥æˆ‘ä»¬æœ‰ä¸€ä¸ªç®€åŒ–çš„ Raft æ¶æ„ï¼š

```text
Client -> RPC -> Leader -> raft.Start(op) -> ... -> applyCh -> applyLoop -> çŠ¶æ€æ›´æ–°
```

å¦‚æœä½ åœ¨ handler ä¸­ç›´æ¥æ›´æ–° `sm.configs`ï¼š

- åªæœ‰è¿™ä¸ª server ä¼šæ›´æ–°ï¼›
- å¦‚æœå®ƒä¸æ˜¯ Leaderï¼Œåˆ™å®¢æˆ·ç«¯è°ƒç”¨å¤±è´¥ï¼Œä¸”æ›´æ–°ä¹Ÿä¸èƒ½ä¼ æ’­ï¼›
- å¦‚æœå®ƒæ˜¯ Leaderï¼Œä¹Ÿå¯èƒ½åœ¨ raft.Start(op) æˆåŠŸä¹‹å‰æŒ‚æ‰ï¼Œæ—¥å¿—ä¸¢å¤±ï¼Œ**çŠ¶æ€å˜äº†ä½†æ—¥å¿—æ²¡è®°ä¸‹æ¥ï¼Œç³»ç»Ÿå°±ä¸ä¸€è‡´äº†ï¼**

è¿™æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ€å±é™©çš„æƒ…å†µ â€”â€” **æœªè¾¾æˆå…±è¯†çš„çŠ¶æ€å˜æ›´**ã€‚

------

### ğŸš© åŸå›  2ï¼š**çŠ¶æ€æœºæ›´æ–°å¿…é¡»æ˜¯â€œç¡®å®šæ€§ +ä¸€è‡´æ€§â€**

å¦‚æœæ¯ä¸ª server éƒ½ç‹¬ç«‹æ‰§è¡Œ handler ä¸­çš„é€»è¾‘ï¼Œè¡Œä¸ºå¯èƒ½ä¸ä¸€æ ·ï¼ˆæ¯”å¦‚å½“å‰é…ç½®ä¸åŒï¼Œå¯¼è‡´ rebalance ä¸åŒï¼‰ï¼Œé‚£å°±ä¼šå‡ºç°ï¼š

```text
Server A: configs[1] = join(101) + rebalanceA
Server B: configs[1] = join(101) + rebalanceB
```

å³ä¾¿ä½ æŠŠ config å…¨æ”¾è¿› raft æ—¥å¿—ï¼Œå¦‚æœæ„é€ é€»è¾‘åœ¨ handlerï¼Œ**æ¯ä¸ª server æ„é€ çš„å†…å®¹éƒ½ä¸åŒï¼Œæœ€ç»ˆç»“æœä¹Ÿä¸åŒ** â€”â€” è¿™å°±ä¸æ˜¯â€œå¤åˆ¶çŠ¶æ€æœºâ€äº†ã€‚

------

### ğŸš© åŸå›  3ï¼š**Raft çš„ apply é¡ºåºæ˜¯å”¯ä¸€å¯ä¿¡çš„æ—¶é—´è½´**

handler ä¸­çš„æ—¶é—´æ˜¯â€œå¹¶å‘çš„â€ï¼ŒRaft æ—¥å¿—ä¸­çš„æ—¶é—´æ˜¯â€œçº¿æ€§çš„â€ã€‚

ä½ å¯ä»¥è¿™æ ·æƒ³ï¼š

| ä½ç½®        | æ“ä½œé€»è¾‘                          |
| ----------- | --------------------------------- |
| RPC handler | æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå°è£…ä¸ºæ“ä½œ intent |
| Raft apply  | é¡ºåºæ‰§è¡Œæ“ä½œæ„å›¾ï¼Œæœ€ç»ˆæ”¹å˜çŠ¶æ€    |

**é€»è¾‘æ›´æ–°å¿…é¡»ç»‘å®šåˆ° Raft apply é¡ºåºä¸Šæ‰èƒ½æ­£ç¡®ã€‚**

------

## âœ… ä¸¾ä¾‹ç›´è§‚å¯¹æ¯”

### âŒ å¦‚æœä½ åœ¨ handler ä¸­æ„é€  configï¼š

```go
prev := sm.configs[len(sm.configs)-1]
newConfig := rebalance(prev + args)
op := Op{Config: newConfig}
```

ä¼šé‡åˆ°è¿™äº›é—®é¢˜ï¼š

- è¿™ä¸ª `prev` æ˜¯ stale çš„ï¼›
- å…¶ä»–å¹¶å‘ Join å¯èƒ½æ„é€ ä¸åŒçš„ configï¼›
- åæäº¤çš„ config ä¼š**è¦†ç›–**å‰ä¸€ä¸ªï¼›
- Raft æäº¤é¡ºåºä¸å†èƒ½å”¯ä¸€å†³å®šçŠ¶æ€ã€‚

### âœ… å¦‚æœä½ åªæäº¤ intentï¼Œåœ¨ apply ä¸­æ„é€  configï¼š

```go
// åœ¨ applyLoop ä¸­
prev := sm.configs[len(sm.configs)-1]
newConfig := rebalance(prev + op.JoinArgs)
sm.configs = append(sm.configs, newConfig)
```

å°±å®Œå…¨æ­£ç¡®äº†ï¼š

- æ‰€æœ‰å‰¯æœ¬éƒ½åœ¨ç›¸åŒæ—¶é—´çœ‹åˆ°ç›¸åŒçš„ prevï¼›
- æ„é€ è¡Œä¸ºä¸€è‡´ï¼›
- çŠ¶æ€æŒ‰æ—¥å¿—é¡ºåºæ¼”è¿›ï¼›
- ç³»ç»Ÿçº¿æ€§ä¸€è‡´ã€‚

------

## âœ… è®¾è®¡æ€»ç»“å£è¯€

> â˜‘ **æäº¤â€œæ„å›¾â€åˆ° Raftï¼Œæ‰§è¡Œé€»è¾‘æ”¾åœ¨ applyã€‚**
>  â˜‘ handler æ°¸è¿œåªæ˜¯åŒ…è£…ï¼ŒçœŸæ­£çš„çŠ¶æ€æ›´æ–°æ°¸è¿œåœ¨ applyLoopã€‚
>  â˜‘ applyLoop æ˜¯â€œä¸–ç•ŒçœŸå®å‘ç”Ÿäº†ä»€ä¹ˆâ€çš„å”¯ä¸€æƒå¨ã€‚

------

## âœ… è¡¥å……ç°å®ç±»æ¯”

ä½ å¯ä»¥æŠŠ Raft æ—¥å¿—æƒ³è±¡æˆä¸€ä¸ªå…¬å¸è‘£äº‹ä¼šçš„**ä¼šè®®çºªè¦**ã€‚

- å®¢æˆ·ç«¯ï¼ˆå‘˜å·¥ï¼‰ç»™ä½ å»ºè®®ï¼ˆJoinã€Leaveï¼‰ï¼›
- Handler æ˜¯ç§˜ä¹¦ï¼Œè®°å½•è¿™ä¸ªå»ºè®®ï¼Œæè®®ç»™è‘£äº‹ä¼šï¼›
- åªæœ‰è‘£äº‹ä¼šé€šè¿‡ã€ä¼šè®®çºªè¦ä¸­è®°å½•ä¸‹æ¥çš„æ“ä½œï¼Œæ‰çœŸæ­£å½±å“å…¬å¸å†³ç­–ã€‚

ğŸ“Œ ä½ ä¸èƒ½è®©ç§˜ä¹¦ç›´æ¥å‘å¸ƒäººäº‹ä»»å‘½ï¼Œè¿™ä¼šå‡ºäº‹çš„ï¼

------

å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥å®Œæ•´å¸®ä½ é‡æ„ Join/Leave/Move/Query è¿™å››ä¸ª RPC æˆä¸ºâ€œæ„å›¾æäº¤ + apply æ‰§è¡Œâ€çš„ç‰ˆæœ¬ã€‚æ˜¯å¦éœ€è¦æˆ‘ç»§ç»­ï¼Ÿ



# çŠ¶æ€æœºæ˜¯å¦‚ä½•æŒ‡å¯¼ç¼–ç¨‹çš„ï¼Ÿæ˜¯æ‰€æœ‰ç¼–ç¨‹éƒ½ä¼šç”¨åˆ°å—ï¼Ÿ

è¿™æ˜¯ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼ä¸‹é¢æˆ‘å°†ç³»ç»Ÿæ€§åœ°å›ç­”ä½ ï¼š

------

## ä¸€ã€çŠ¶æ€æœºå¦‚ä½•æŒ‡å¯¼ç¼–ç¨‹ï¼Ÿ

çŠ¶æ€æœºæœ¬è´¨ä¸Šæ˜¯ä¸€ç§**å»ºæ¨¡æ€ç»´æ–¹å¼**ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬ï¼š

### âœ… 1. **åˆ†æé—®é¢˜é€»è¾‘ï¼š**

è®¸å¤šé—®é¢˜éƒ½å¯ä»¥å½’ç»“ä¸ºâ€œåœ¨ä¸åŒçŠ¶æ€ä¹‹é—´åˆ‡æ¢â€çš„è¿‡ç¨‹ã€‚ä¾‹å¦‚ï¼š

- ç”¨æˆ·æ˜¯å¦ç™»å½•ï¼Ÿ
- ç½‘ç»œè¿æ¥æ˜¯å¦å»ºç«‹ï¼Ÿ
- æ¸¸æˆè§’è‰²æ˜¯é™æ­¢/å¥”è·‘/è·³è·ƒï¼Ÿ

çŠ¶æ€æœºæŠŠè¿™äº›â€œçŠ¶æ€+åˆ‡æ¢â€æŠ½è±¡å‡ºæ¥ï¼Œ**è®©ç³»ç»Ÿè¡Œä¸ºæ›´æ¸…æ™°ã€æ›´æœ‰ç»“æ„**ã€‚

------

### âœ… 2. **ç»„ç»‡ä»£ç ç»“æ„ï¼š**

é€šè¿‡çŠ¶æ€æœºï¼Œä½ å¯ä»¥é¿å…è¿™æ ·æ··ä¹±çš„ä»£ç ï¼š

```go
if userLoggedIn {
	if hasPermission {
		if inEditMode {
			// do something
		}
	}
}
```

è€Œç”¨çŠ¶æ€æœºæ¨¡å¼é‡æ„åï¼Œé€»è¾‘ä¼šæ¸…æ™°å¾ˆå¤šï¼š

```go
switch currentState {
case LoggedOut:
    // ç­‰å¾…ç”¨æˆ·ç™»å½•
case LoggedIn:
    // æ£€æŸ¥æƒé™
case Editing:
    // æ‰§è¡Œç¼–è¾‘åŠ¨ä½œ
}
```

------

### âœ… 3. **æä¾›å¥å£®æ€§å’Œå¯æµ‹è¯•æ€§ï¼š**

çŠ¶æ€æœºå¤©ç”Ÿå°±é€‚åˆï¼š

- è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆçŠ¶æ€ + äº‹ä»¶ -> å”¯ä¸€çš„ç»“æœï¼‰
- å®¹é”™æœºåˆ¶ï¼ˆéæ³•çŠ¶æ€è·³è½¬èƒ½è¢«æ£€æµ‹ï¼‰
- å¹¶å‘ç¼–ç¨‹ï¼ˆæ¯”å¦‚ Raft ç”¨çŠ¶æ€æœºç®¡ç†èŠ‚ç‚¹çŠ¶æ€ï¼‰

------

## äºŒã€æ˜¯ä¸æ˜¯æ‰€æœ‰ç¼–ç¨‹éƒ½ç”¨åˆ°çŠ¶æ€æœºï¼Ÿ

ä¸ä¸€å®šã€‚ä½†å¯ä»¥è¿™æ ·è¯´ï¼š

> **å‡ ä¹æ‰€æœ‰éâ€œä¸€æ¬¡æ€§â€è„šæœ¬ç±»ç¨‹åºï¼ˆå³é•¿æœŸè¿è¡Œçš„ç³»ç»Ÿï¼‰éƒ½**æˆ–**åº”è¯¥**ç”¨åˆ°**çŠ¶æ€ç®¡ç†**çš„æ€æƒ³ï¼Œè€ŒçŠ¶æ€æœºæ­£æ˜¯ç®¡ç†çŠ¶æ€å˜åŒ–çš„æœ€å¥½æ–¹å¼ä¹‹ä¸€ã€‚

### âœ… çŠ¶æ€æœºç‰¹åˆ«é€‚åˆçš„åœºæ™¯ï¼š

- ç½‘ç»œé€šä¿¡åè®®ï¼ˆTCPã€HTTPï¼‰
- UI é¡µé¢æµç¨‹æ§åˆ¶ï¼ˆä¾‹å¦‚ç‚¹å‡» -> åŠ è½½ -> æˆåŠŸ/å¤±è´¥ï¼‰
- åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼ˆRaftã€Paxosï¼‰
- æ¸¸æˆå¼€å‘ï¼ˆè§’è‰²åŠ¨ä½œçŠ¶æ€ï¼‰
- è®¾å¤‡æ§åˆ¶ï¼ˆå¦‚è‡ªåŠ¨é—¨ã€æ´—è¡£æœºï¼‰
- ç¼–è¯‘å™¨è®¾è®¡ï¼ˆçŠ¶æ€æœºè¯†åˆ« tokenï¼‰

### ğŸš« ä¸ä¸€å®šç”¨çŠ¶æ€æœºçš„åœºæ™¯ï¼š

- ç®€å•çš„è„šæœ¬ï¼ˆä¸€æ¬¡æ€§æ–‡ä»¶å¤„ç†ã€æ•°æ®åˆ†æç­‰ï¼‰
- çº¯å‡½æ•°å¼ç¼–ç¨‹ä¸­ï¼ŒçŠ¶æ€å˜åŒ–å°‘

------

## ä¸‰ã€ä»€ä¹ˆæ—¶å€™è¯¥ç”¨çŠ¶æ€æœºï¼Ÿ

- **å½“ä½ å‘ç°ä»£ç ä¸­æœ‰å¾ˆå¤š `if` æˆ– `switch` åˆ†æ”¯åˆ¤æ–­çŠ¶æ€**
- **å½“çŠ¶æ€ä¹‹é—´æœ‰æ˜ç¡®â€œè½¬æ¢æ¡ä»¶â€**
- **å½“ä½ æƒ³è¦ç³»ç»Ÿæ›´æ¸…æ™°åœ°æè¿°æµç¨‹/è¡Œä¸º**

------

## å››ã€æ€»ç»“

| é—®é¢˜                     | å›ç­”                                    |
| ------------------------ | --------------------------------------- |
| çŠ¶æ€æœºæŒ‡å¯¼ç¼–ç¨‹çš„æ–¹å¼ï¼Ÿ   | æŠŠâ€œçŠ¶æ€+è¡Œä¸ºâ€æ˜¾å¼å»ºæ¨¡ï¼Œä½¿é€»è¾‘æ¸…æ™°ã€å¥å£® |
| æ‰€æœ‰ç¼–ç¨‹éƒ½éœ€è¦çŠ¶æ€æœºå—ï¼Ÿ | ä¸ï¼Œä½†åªè¦æ¶‰åŠçŠ¶æ€å˜åŒ–ï¼Œéƒ½å¯ä»¥ä»ä¸­å—ç›Š  |
| çŠ¶æ€æœºçš„ç¼–ç¨‹ä»·å€¼ï¼Ÿ       | æ›´å¥½çš„ä»£ç ç»“æ„ã€æµ‹è¯•æ€§ã€æ‰©å±•æ€§          |

------

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥ç»™ä½ å®‰æ’å‡ ä¸ª**ä»ç®€å•åˆ°å¤æ‚çš„çŠ¶æ€æœºä¾‹å­**ï¼Œè¾¹å­¦è¾¹ç»ƒã€‚ä½ æƒ³ä»å“ªç§åœºæ™¯å­¦èµ·ï¼Ÿï¼ˆæ¯”å¦‚æ¸¸æˆã€HTTPåè®®ã€UIæµç¨‹ã€Raftç­‰ï¼‰





è¿™å¼ å›¾æ˜¯ä½ æ‰‹ç»˜çš„ **ShardKV çŠ¶æ€æœºå˜åŒ–å›¾**ï¼Œæè¿°äº†åœ¨ MIT 6.824 Lab4 ä¸­åˆ†ç‰‡é…ç½®å˜æ›´æ—¶ï¼Œ`ShardKV` èŠ‚ç‚¹ç»å†çš„**çŠ¶æ€åˆ‡æ¢è¿‡ç¨‹**ã€‚æˆ‘æ¥å¸®ä½ å®Œæ•´è¿˜åŸå¹¶è¯¦ç»†è§£é‡Šæ¯ä¸ªçŠ¶æ€ä¸è½¬æ¢é€»è¾‘ã€‚

------

## ğŸŒ çŠ¶æ€èŠ‚ç‚¹è§£æ

å›¾ä¸­å…±æœ‰å››ä¸ªä¸»è¦çŠ¶æ€ï¼š

```
1. Serving
2. Pulling
3. Repulling
4. Gcing
```

å®ƒä»¬è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ‰€å¤„çš„é˜¶æ®µï¼š

### 1. **Serving**ï¼ˆæœåŠ¡ä¸­ï¼‰

- æ­£å¸¸æä¾› `Get/Put/Append` è¯·æ±‚å¤„ç†ã€‚
- å½“å‰æŒæœ‰çš„æ‰€æœ‰ shard éƒ½å¤„äºå¯æœåŠ¡çŠ¶æ€ã€‚
- å¤„äºæ­¤çŠ¶æ€çš„å‰ææ˜¯ï¼š**å·²å®Œæˆé…ç½®è¿ç§»åŠæ—§åˆ†ç‰‡æ¸…ç†**ã€‚

### 2. **Pulling**ï¼ˆæ‹‰å– shard ä¸­ï¼‰

- çŠ¶æ€è§¦å‘ï¼šæ£€æµ‹åˆ° `new config`ï¼Œå…¶ä¸­æœ‰ **æ–°çš„ shard è¢«åˆ†é…åˆ°å½“å‰ç»„**ã€‚
- åŠ¨ä½œï¼šå¼‚æ­¥ä»æ—§ GID æ‹‰å–è¿™äº› shard çš„æ•°æ®ï¼ˆé€šè¿‡ RPCï¼‰ã€‚
- ç‰¹å¾ï¼šå¯èƒ½æœ‰äº› shard å¯æœåŠ¡ï¼Œæœ‰äº›å°šæœªå‡†å¤‡å¥½ã€‚

### 3. **Repulling**ï¼ˆé‡æ‹‰ä¸­ï¼‰

- çŠ¶æ€è§¦å‘ï¼šéƒ¨åˆ† shard æ‹‰å–å¤±è´¥æˆ–æ•°æ®ä¸å®Œæ•´ã€‚
- åŠ¨ä½œï¼šç»§ç»­é‡å¤æ‹‰å–å°šæœªæˆåŠŸçš„ shardã€‚
- ç‰¹å¾ï¼šä¾èµ–è¿œç¨‹çš„æ‰§è¡ŒæˆåŠŸï¼ˆå›¾ä¸Šæ ‡æ³¨ï¼š**è¿œç¨‹çš„ execute**ï¼‰ã€‚

### 4. **Gcing**ï¼ˆGC æ¸…ç†ï¼‰

- çŠ¶æ€è§¦å‘ï¼šæ‰€æœ‰ shard æ‹‰å–å®Œæ¯•ï¼Œè¿›å…¥æœ¬åœ°æ¸…ç†é˜¶æ®µã€‚
- åŠ¨ä½œï¼šå‘æ—§ GID å‘èµ· GC RPCï¼Œå‘Šè¯‰å®ƒï¼š**æˆ‘å·²ç»æ‹¿åˆ° shardï¼Œå¯ä»¥åˆ äº†**ã€‚
- ç‰¹å¾ï¼šæ˜¯æœ¬åœ°é€»è¾‘é©±åŠ¨çš„ï¼ˆå›¾ä¸Šæ ‡æ³¨ï¼š**æœ¬åœ° execute**ï¼‰ã€‚

------

## ğŸ” çŠ¶æ€è½¬æ¢æµç¨‹

æ ¹æ®å›¾ä¸­çš„ç®­å¤´åŠæ–‡å­—è¯´æ˜ï¼Œæ¨å¯¼å¦‚ä¸‹ï¼š

```text
ã€åˆå§‹ã€‘Serving
    â†“ new config åˆ°è¾¾
    â†’ Pullingï¼ˆå¼€å§‹å¼‚æ­¥ä»å…¶ä»– GID æ‹‰ shardï¼‰

Pulling
    â†“ å¦‚æœæ‹‰å–å¤±è´¥ï¼ˆè¶…æ—¶/è¿æ¥å¤±è´¥ç­‰ï¼‰
    â†’ Repullingï¼ˆé‡æ–°å‘èµ· RPCï¼‰

Pulling or Repulling
    â†“ æ‹‰å–æˆåŠŸï¼ˆæ•°æ®+lastResultï¼‰
    â†’ Gcingï¼ˆå¼€å§‹é€šçŸ¥æ—§ GID å¯ä»¥åˆ é™¤ shardï¼‰

Gcing
    â†“ GC è¿‡ç¨‹å®Œæˆ
    â†’ Servingï¼ˆæ–°é…ç½®å®Œå…¨ readyï¼‰
```

### ğŸ”„ ç‰¹æ®Šè¯´æ˜ï¼š

- ä» `Repulling` æˆåŠŸåä»ç„¶è¿›å…¥ `Gcing`ï¼Œæµç¨‹ä¸€è‡´ã€‚
- GC é€»è¾‘å®Œæˆåæ‰å¯ä»¥è®¤ä¸ºç³»ç»Ÿè¿›å…¥æ–°ç¨³å®šçŠ¶æ€ã€‚

------

## âœ… æ€»ç»“é€»è¾‘å…³é”®ç‚¹

| çŠ¶æ€      | æ„ä¹‰                             | æ˜¯å¦å¯æœåŠ¡ | ä¾èµ–ä½•æ–¹æ‰§è¡Œ |
| --------- | -------------------------------- | ---------- | ------------ |
| Serving   | æ‰€æœ‰ shard æ­£å¸¸                  | âœ…          | â€”            |
| Pulling   | æ­£åœ¨è¿œç¨‹æ‹‰å– shard               | âŒï¼ˆéƒ¨åˆ†ï¼‰  | è¿œç¨‹ RPC     |
| Repulling | ä¸Šæ¬¡æ‹‰å¤±è´¥ï¼Œç»§ç»­æ‹‰               | âŒï¼ˆéƒ¨åˆ†ï¼‰  | è¿œç¨‹ RPC     |
| Gcing     | æ‰€æœ‰ shard åˆ°é½ï¼Œé€šçŸ¥æ—§ GID æ¸…ç† | âœ…          | æœ¬åœ°æ‰§è¡Œ     |

------

## ğŸ§  ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸ªâ€œçŠ¶æ€æœºâ€ï¼Ÿ

- æ¯ä¸ªçŠ¶æ€æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè½¬æ¢æ˜¯äº‹ä»¶è§¦å‘çš„åŠ¨ä½œã€‚
- ä½ å¯ä»¥é€šè¿‡ FSM çš„æ–¹å¼ç¼–ç¨‹å®ç°ï¼š

```go
switch kv.state {
case Serving:
    if newConfig.Num > kv.lastConfig.Num {
        kv.state = Pulling
    }
case Pulling:
    if pullSuccess {
        kv.state = Gcing
    } else if timeout {
        kv.state = Repulling
    }
case Repulling:
    if pullSuccess {
        kv.state = Gcing
    }
case Gcing:
    if gcComplete {
        kv.state = Serving
    }
}
```

è¿™å°±æ˜¯çŠ¶æ€æœºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­åº”ç”¨çš„å…¸å‹ä¾‹å­ã€‚

------

å¦‚æœä½ æƒ³ï¼Œæˆ‘å¯ä»¥ç”¨è¿™å¼ å›¾ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„ Go çŠ¶æ€åˆ‡æ¢æ¡†æ¶æˆ–è€… PlantUML çŠ¶æ€å›¾å½¢å¼æ¥å¸®åŠ©ä½ ç¼–ç ã€‚æ˜¯å¦éœ€è¦ï¼Ÿ