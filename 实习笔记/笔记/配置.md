

# standard_event

这个 JSON 数据结构定义了一组不同的事件代码（event code），并将它们分成多个类别（从 0 到 8）。每个类别对应一个数组，数组中的字符串是事件代码。这种分类可以帮助你在不同的场景或功能模块中对事件进行管理和处理。下面是对每个类别的详细解释：

### 0 类别

```
json
复制代码
"0": [
  "e#close_third_party_app",
  "e#web_jsapi_analyser"
]
```

这个类别包含与第三方应用和 Web JSAPI 分析相关的事件。可能用于记录和管理用户在会议软件中与第三方应用或 Web JSAPI 的交互。

### 1 类别

```
json
复制代码
"1": [
  "e#user_update_avatar",
  "e#user_update_password",
  "e#user_update_phone",
  "e#user_update_user_name",
  "e#user_update_wechat"
]
```

这个类别包含用户更新个人信息的事件，包括更新头像、密码、手机、用户名和微信。用于跟踪用户在系统中的个人信息修改操作。

### 2 类别

```
json
复制代码
"2": [
  "e#abtest_item_label_filter",
  "e#abtest_label_filter",
  "e#abtest_last_filter_result",
  "e#abtest_tab_filter"
]
```

这个类别包含与 A/B 测试相关的事件。用于记录和管理 A/B 测试中的各种标签和筛选结果。

### 3 类别

```
json
复制代码
"3": [
  "e#mute",
  "e#unmute",
  "e#open_share_audio",
  "e#close_share_audio",
  ...
]
```

这个类别包含大量与会议功能操作相关的事件，包括静音、取消静音、音频分享、屏幕分享、会议创建、会议编辑等操作。用于记录和管理用户在会议中的各种操作行为。

### 4 类别

```
json
复制代码
"4": [
  "e#open_third_party_app",
  "e#close_third_party_app"
]
```

这个类别包含打开和关闭第三方应用的事件。用于记录用户与第三方应用的交互情况。

### 5 类别

```
json
复制代码
"5": [
  "e#create_meeting"
]
```

这个类别只包含创建会议的事件。用于记录用户创建会议的操作。

### 6 类别

```
json
复制代码
"6": [
  "e#account_corp_user_resources",
  "e#corp_used_resource_report"
]
```

这个类别包含与公司用户资源相关的事件。用于记录和管理公司账户资源的使用情况。

### 7 类别

```
json
复制代码
"7": [
  "e#ai_chapter_result",
  "e#ai_speaker_result",
  "e#ai_note_result",
  ...
]
```

这个类别包含与 AI 功能相关的事件，包括 AI 章节结果、AI 演讲者结果、AI 笔记结果等。用于记录和管理 AI 功能在会议中的应用情况。

### 8 类别

```
json
复制代码
"8": [
  "e#corp_used_resource_detailed_report",
  "e#role_auth_corp_resource",
  "e#begin_live",
  ...
]
```

这个类别包含与公司资源、角色权限、直播相关的事件。用于记录和管理公司资源的详细报告、角色权限和直播操作等。

### 



如果我们调用 `calEventCode("e#user_update_avatar")`，计算过程如下：

1. `index = 0`，`item = {"e#close_third_party_app": {}, "e#web_jsapi_analyser": {}}`：
   - `e#user_update_avatar` 不在 `item` 中，不做处理。
2. `index = 1`，`item = {"e#user_update_avatar": {}, "e#user_update_password": {}, "e#user_update_phone": {}, "e#user_update_user_name": {}, "e#user_update_wechat": {}}`：
   - `e#user_update_avatar` 在 `item` 中存在。
   - 初始化 `flag = 00000001`，左移 1 位后 `flag = 00000010`，即 `2`。
   - `result = 0 | 2`，结果为 `2`。
3. `index = 2`，`item = {"e#abtest_item_label_filter": {}, "e#abtest_label_filter": {}, "e#abtest_last_filter_result": {}, "e#abtest_tab_filter": {}}`：
   - `e#user_update_avatar` 不在 `item` 中，不做处理。

所以，调用 `calEventCode("e#user_update_avatar")` 的结果为 `2`。

### 总结

`calEventCode` 函数通过遍历动态配置映射表，检查事件在不同位置的存在情况，并通过左移和按位或运算，计算出一个整数标记值。这种方式可以快速检查某个事件是否被配置，并生成一个可以用于进一步处理的标记值。







# send_atta_sample

### 分析流程

我们将使用 `IsSendAtta` 函数以及提供的规则集来分析一次具体的流程。我们会使用一个示例参数集 `parameters` 来进行演示。

假设 `parameters` 为：

```
go
复制代码
parameters := map[string]string{
    "corp_id": "200000001",
    "event_code": "res_update_task_event",
    "action": "res_record",
    "uid": "12345",
}
```

### 规则集

```
json
复制代码
[
  {
    "name": "cgi_configure_failed",
    "disabled": false,
    "end_time": 1910881523,
    "multi_sample": 0,
    "log_config": {
      "key": "event_code",
      "whitelist": [
        "cgi_configure_failed"
      ],
      "sample_rate": 0.1
    }
  },
  {
    "name": "res_update_task_event",
    "disabled": false,
    "operator_type": 1,
    "end_time": 1915627211,
    "sub_rules": [
      {
        "name": "res_update_task_event",
        "level": 1,
        "log_config": {
          "key": "event_code",
          "whitelist": [
            "res_update_task_event"
          ],
          "sample_rate": 0
        }
      },
      {
        "name": "action",
        "level": 1,
        "log_config": {
          "key": "action",
          "whitelist": [
            "res_record"
          ],
          "sample_rate": 0.5
        }
      }
    ]
  },
  {
    "name": "video_decoder_base_info_stats",
    "disabled": false,
    "operator_type": 1,
    "end_time": 1915627211,
    "sub_rules": [
      {
        "name": "video_decoder_base_info_stats",
        "level": 1,
        "log_config": {
          "key": "event_code",
          "whitelist": [
            "video_decoder_base_info_stats"
          ],
          "sample_rate": 0
        }
      },
      {
        "name": "uid",
        "level": 1,
        "log_config": {
          "type": 1,
          "key": "uid",
          "denominator": 100,
          "range_rate": 50
        }
      }
    ]
  }
]
```

### 分析过程

1. **选择规则集**：

   - 因为 `parameters["corp_id"] == "200000001"`，调用 `GetSendAttaRules()` 获取规则集。

2. **初始化 `SendSample`**：

   ```
   go
   复制代码
   st := &SendSample{
       IsSend:      true,
       MultiSample: 0,
   }
   ```

3. **初始化度量指标变量**：

   ```
   go
   复制代码
   var ms []*metrics.Metrics
   var dims []*metrics.Dimension
   passResult := "0"
   ```

4. **遍历规则**：

   - **规则 1**：`cgi_configure_failed`

     - 事件代码不匹配，跳过。

   - **规则 2**：`res_update_task_event`

     - 事件代码匹配，添加维度信息和度量指标：

       ```
       go
       复制代码
       dims = append(dims, &metrics.Dimension{Name: "event_code", Value: rule.Name})
       ms = append(ms, metrics.NewMetrics("SendSample", 1, metrics.PolicySUM))
       ```

     - 调用 `AttaPass` 方法：

       - **子规则 1**：`res_update_task_event`
         - 事件代码匹配，采样率为 0，返回 `true`。
       - **子规则 2**：`action`
         - action 匹配 `res_record`，采样率为 0.5。假设这次随机数小于 0.5，则返回 `true`。

     - 所有子规则都通过，`st.IsSend` 保持 `true`，继续遍历。

   - **规则 3**：`video_decoder_base_info_stats`

     - 事件代码不匹配，跳过。

5. **记录度量信息**：

   - ```
     ms
     ```

      不为空，添加结果维度并上报多维度度量指标：

     ```
     go
     复制代码
     if len(ms) > 0 {
         dims = append(dims, &metrics.Dimension{Name: "result", Value: passResult})
         metrics.Report(metrics.NewMultiDimensionMetrics(dims, ms))
     }
     ```

6. **返回结果**：

   - 返回 

     ```
     SendSample
     ```

      结构体实例：

     ```
     go
     复制代码
     return st
     ```

### `AttaPass` 方法示例实现

```
go
复制代码
func (r SampleRule) AttaPass(parameters map[string]string) bool {
	if r.Disabled || r.EndTime < time.Now().Unix() {
		return false
	}
	value, exists := parameters[r.LogConfig.Key]
	if !exists {
		return false
	}

	// Check if the value is in the whitelist
	for _, item := range r.LogConfig.Whitelist {
		if item == value {
			return true
		}
	}

	// Check sampling rate
	if rand.Float64() < r.LogConfig.SampleRate {
		return true
	}

	return false
}
```

### 结论

通过上述分析，`IsSendAtta` 函数可以根据传入的参数集和规则集，判断某个事件是否需要发送到 Atta。通过遍历规则集并调用 `AttaPass` 方法，逐个检查事件是否符合规则，最终返回一个包含发送状态和采样倍数的结构体实例。



# stragey

#### 流程解析

1. **策略匹配**：
   - 在 `HandleStrategyAction` 中，获取所有策略并遍历。
   - 检查每个策略的 `Condition` 是否满足。例如，`Req.Product == 'meeting' && Req.Channel == 'server'`。
2. **执行策略**：
   - 对于每个满足条件的策略，调用 `DoMtxStrategy`。
   - 在 `DoMtxStrategy` 中，创建表达式并执行规则。
   - 调用 `MakeFormatData` 生成数据。
   - 调用 `SendAction` 执行动作。
3. **动作匹配与执行**：
   - 在 `DoMtxStrategy` 中，遍历所有动作。
   - 检查每个动作的 `When` 条件是否满足。例如，`Req.EventCode in ('wemeet_toutiao_daily_reports_test', ...)`。
   - 满足条件的动作会被执行，调用 `SendAction` 完成动作执行。





要设计一个具有良好扩展性并且易于插入不同加密逻辑的系统，可以采用策略模式（Strategy Pattern）。策略模式允许你定义一系列算法，将每个算法封装到独立的类中，使它们可以相互替换，并且使得算法的变化独立于使用算法的客户。

以下是一个基于策略模式的加密逻辑框架设计：

### 1. 定义加密策略接口

首先定义一个加密策略接口，所有的加密算法都需要实现这个接口。

```
go
复制代码
// EncryptStrategy defines the interface for encryption strategies
type EncryptStrategy interface {
    Encrypt(c context.Context, reqMap map[string]string) error
}
```

### 2. 实现具体的加密策略

然后为每种具体的加密逻辑实现相应的加密策略类。

```
go
复制代码
// TencentSelfEncryptStrategy implements encryption for Tencent self parameters
type TencentSelfEncryptStrategy struct{}

func (s *TencentSelfEncryptStrategy) Encrypt(c context.Context, reqMap map[string]string) error {
    EncryptField(c, reqMap, "field", TXGCbcKey) // 具体加密逻辑
    return nil
}

// NonTencentSelfEncryptStrategy implements encryption for non-Tencent self parameters
type NonTencentSelfEncryptStrategy struct{}

func (s *NonTencentSelfEncryptStrategy) Encrypt(c context.Context, reqMap map[string]string) error {
    EncryptField(c, reqMap, "field", GCGbcKey) // 具体加密逻辑
    return nil
}

// PublicParaEncryptStrategy implements encryption for public parameters
type PublicParaEncryptStrategy struct{}

func (s *PublicParaEncryptStrategy) Encrypt(c context.Context, reqMap map[string]string) error {
    EncryptMultiField(c, reqMap, TXGCbcKey, "uid", "meeting_code")
    return nil
}

// BackendEncryptStrategy implements encryption for backend parameters
type BackendEncryptStrategy struct{}

func (s *BackendEncryptStrategy) Encrypt(c context.Context, reqMap map[string]string) error {
    // 具体加密逻辑，基于事件类型、corp_id等
    if reqMap["event_code"] == "e#create_meeting" && reqMap["corp_id"] == "creator_uid" {
        EncryptMultiField(c, reqMap, TXGCbcKey, "uid", "meeting_code")
    } else {
        // 其他逻辑
    }
    return nil
}
```

### 3. 创建上下文类

上下文类持有一个策略实例，并调用策略的加密方法。

```
go
复制代码
// EncryptContext is the context for encryption
type EncryptContext struct {
    strategy EncryptStrategy
}

// SetStrategy sets the encryption strategy
func (ctx *EncryptContext) SetStrategy(strategy EncryptStrategy) {
    ctx.strategy = strategy
}

// Encrypt executes the encryption strategy
func (ctx *EncryptContext) Encrypt(c context.Context, reqMap map[string]string) error {
    return ctx.strategy.Encrypt(c, reqMap)
}
```

### 4. 使用策略模式

根据不同的情况设置不同的策略，并进行加密。

```
go
复制代码
func main() {
    c := context.Background()
    reqMap := map[string]string{
        "corp_id": "200000001",
        "event_code": "e#create_meeting",
        // 其他参数
    }

    ctx := &EncryptContext{}

    // 根据不同的条件设置策略
    if reqMap["corp_id"] == "200000001" {
        ctx.SetStrategy(&TencentSelfEncryptStrategy{})
    } else if reqMap["corp_id"] == "200000000" {
        ctx.SetStrategy(&NonTencentSelfEncryptStrategy{})
    } else {
        ctx.SetStrategy(&PublicParaEncryptStrategy{})
    }

    // 执行加密
    if err := ctx.Encrypt(c, reqMap); err != nil {
        log.Fatalf("Encryption failed: %v", err)
    }

    // 打印加密结果
    fmt.Println("Encrypted reqMap:", reqMap)
}
```

### 总结

这种设计方式可以很好地满足扩展性要求，当需要增加新的加密逻辑时，只需实现新的加密策略类，并在上下文中设置相应的策略即可。这样可以避免在一个大的函数中添加大量的条件判断逻辑，保持代码的清晰和可维护性。

事件{

是否腾讯{

来源{

​	私参

​	公参

}

}

}

# 加密

1。对客户端私参加密，腾讯企业使用 TXGCbcKey加密指定字段。非腾讯企业使用 GCGbcKey 加密指定字段。2.对消息后台公共参数加密，使用 TXGCbcKey 加密制定字段3.腾讯会议后台的私参加密，腾讯企业且事件为创建会议，使用TXGCbcKey加密制定字段，对于腾讯企业且事件不是创建会议，并且creator_corp_id 等于给定值，使用TXGCbcKey加密另一些制定字段，对于腾讯企业且事件不是创建会议，并且creator_corp_id 不等于给定值，使用TXGCbcKey加密另一些制定字段。非腾讯企业使用GCGbcKey加密指定字段。加密现有规则如上，请你帮我编写一个json规则，不但能满足现有规则，而且后续对于任何其它事件【例如离开会议等等】，任何需要加密字段的制定与改变都可以适用，具有良好拓展性

对于客户端发来的请求私参加密，腾讯企业





为了满足这个新需求，我们需要在JSON规则中添加新的加密规则，分别为腾讯企业和非腾讯企业定义加密字段和密钥。以下是更新后的JSON规则：

```
json
复制代码
{
  "encryption_rules": [
    {
      "company_type": "tencent",
      "event_code": "create_meeting",
      "fields": ["uid", "meeting_code"],
      "key": "TXGCbcKey"
    },
    {
      "company_type": "tencent",
      "event_code": "default",
      "fields": ["uid", "meeting_code", "creator_uid"],
      "key": "TXGCbcKey",
      "conditions": {
        "creator_corp_id": ["envCorpId"]
      }
    },
    {
      "company_type": "non_tencent",
      "event_code": "default",
      "fields": ["uid", "meeting_code"],
      "key": "GCGbcKey"
    },
    {
      "company_type": "tencent",
      "event_code": "leave_meeting",
      "fields": ["uid", "meeting_code", "leave_reason"],
      "key": "TXGCbcKey"
    },
    {
      "company_type": "public",
      "event_code": "default",
      "fields": ["uid", "meeting_code"],
      "key": "TXGCbcKey"
    },
    {
      "company_type": "tencent",
      "event_code": "speak_event",
      "fields": ["a", "b", "c"],
      "key": "PublicKey1"
    },
    {
      "company_type": "tencent",
      "event_code": "speak_event",
      "fields": ["d", "e", "f"],
      "key": "PrivateKey2"
    },
    {
      "company_type": "non_tencent",
      "event_code": "speak_event",
      "fields": ["g", "h"],
      "key": "PublicKey3"
    },
    {
      "company_type": "non_tencent",
      "event_code": "speak_event",
      "fields": ["q", "w"],
      "key": "PrivateKey4"
    }
  ]
}
```

### 解释

- 添加了 

  ```
  speak_event
  ```

   事件的规则：

  - 腾讯企业的公共参数使用 `PublicKey1` 加密 `a`, `b`, `c` 字段。
  - 腾讯企业的私有参数使用 `PrivateKey2` 加密 `d`, `e`, `f` 字段。
  - 非腾讯企业的公共参数使用 `PublicKey3` 加密 `g`, `h` 字段。
  - 非腾讯企业的私有参数使用 `PrivateKey4` 加密 `q`, `w` 字段。

### 代码实现示例

以下是如何解析和应用这些规则的示例代码：

```
go
复制代码
package main

import (
	"context"
	"encoding/json"
	"fmt"
	"log"
)

// Rule defines a single encryption rule
type Rule struct {
	CompanyType string            `json:"company_type"`
	EventCode   string            `json:"event_code"`
	Fields      []string          `json:"fields"`
	Key         string            `json:"key"`
	Conditions  map[string][]string `json:"conditions,omitempty"`
}

// RulesConfig defines the rules configuration
type RulesConfig struct {
	Rules []Rule `json:"encryption_rules"`
}

// LoadRules loads the rules from JSON data
func LoadRules(data []byte) (*RulesConfig, error) {
	var config RulesConfig
	if err := json.Unmarshal(data, &config); err != nil {
		return nil, err
	}
	return &config, nil
}

// MatchConditions checks if the parameters match the conditions
func MatchConditions(params map[string]string, conditions map[string][]string) bool {
	for key, values := range conditions {
		paramValue, exists := params[key]
		if !exists {
			return false
		}
		match := false
		for _, value := range values {
			if paramValue == value {
				match = true
				break
			}
		}
		if !match {
			return false
		}
	}
	return true
}

// EncryptField simulates the encryption of a field
func EncryptField(c context.Context, reqMap map[string]string, field, key string) {
	// Simulated encryption logic
	reqMap[field] = "encrypted_" + reqMap[field] + "_with_" + key
}

// ApplyRules applies the matching rules to the parameters
func ApplyRules(c context.Context, params map[string]string, config *RulesConfig) {
	for _, rule := range config.Rules {
		if rule.CompanyType == params["company_type"] && (rule.EventCode == params["event_code"] || rule.EventCode == "default") {
			if rule.Conditions == nil || MatchConditions(params, rule.Conditions) {
				for _, field := range rule.Fields {
					if _, exists := params[field]; exists {
						EncryptField(c, params, field, rule.Key)
					}
				}
			}
		}
	}
}

func main() {
	jsonData := `{
		"encryption_rules": [
			{
				"company_type": "tencent",
				"event_code": "create_meeting",
				"fields": ["uid", "meeting_code"],
				"key": "TXGCbcKey"
			},
			{
				"company_type": "tencent",
				"event_code": "default",
				"fields": ["uid", "meeting_code", "creator_uid"],
				"key": "TXGCbcKey",
				"conditions": {
					"creator_corp_id": ["envCorpId"]
				}
			},
			{
				"company_type": "non_tencent",
				"event_code": "default",
				"fields": ["uid", "meeting_code"],
				"key": "GCGbcKey"
			},
			{
				"company_type": "tencent",
				"event_code": "leave_meeting",
				"fields": ["uid", "meeting_code", "leave_reason"],
				"key": "TXGCbcKey"
			},
			{
				"company_type": "public",
				"event_code": "default",
				"fields": ["uid", "meeting_code"],
				"key": "TXGCbcKey"
			},
			{
				"company_type": "tencent",
				"event_code": "speak_event",
				"fields": ["a", "b", "c"],
				"key": "PublicKey1"
			},
			{
				"company_type": "tencent",
				"event_code": "speak_event",
				"fields": ["d", "e", "f"],
				"key": "PrivateKey2"
			},
			{
				"company_type": "non_tencent",
				"event_code": "speak_event",
				"fields": ["g", "h"],
				"key": "PublicKey3"
			},
			{
				"company_type": "non_tencent",
				"event_code": "speak_event",
				"fields": ["q", "w"],
				"key": "PrivateKey4"
			}
		]
	}`

	config, err := LoadRules([]byte(jsonData))
	if err != nil {
		log.Fatalf("Failed to load rules: %v", err)
	}

	params := map[string]string{
		"company_type": "tencent",
		"event_code":   "speak_event",
		"a":            "valueA",
		"b":            "valueB",
		"c":            "valueC",
		"d":            "valueD",
		"e":            "valueE",
		"f":            "valueF"
	}

	c := context.Background()

	ApplyRules(c, params, config)

	fmt.Println("Encrypted params:", params)
}
```

### 

 "encryption_method": "AES"

```json
{
  "keys": {
    "tencent": {
      "test": {
        "public_key": "ecdfa8bc-75ca-4f25-b869-65df635afac9",
        "private_key": "de9a5fb7-e54f-4cbf-b642-8544c6d92c73"
      },
      "prod": {
        "public_key": "another-public-key-id-for-prod",
        "private_key": "another-private-key-id-for-prod"
      }
    },
    "non_tencent": {
      "test": {
        "public_key": "487c4b50-6daa-4b8d-9ca5-5d2037533858",
        "private_key": "333b7ef9-cb53-4c5f-a618-585c8a538f5c"
      },
      "prod": {
        "public_key": "yet-another-public-key-id-for-prod",
        "private_key": "yet-another-private-key-id-for-prod"
      }
    }
  },
  "rules": [
    {
      "conditions": {
        "company_type": "tencent",
        "event_code": "create_meeting",
        "source": "client"
      },
      "fields": {
        "private": {
          "namespace": "test",
          "key": "TXGCbcKey",
          "fields": ["uid", "meeting_code"]
        },
        "public": {
          "namespace": "test",
          "key": "TXGCbcKey",
          "fields": ["field1", "field2"]
        }
      }
    },
    {
      "id": "2",
      "conditions": {
        "company_type": "tencent",
        "event_code": "default",
        "source": "client",
        "additional_conditions": {
          "creator_corp_id": ["envCorpId"]
        }
      },
      "fields": {
        "private": {
          "namespace": "test",
          "key": "TXGCbcKey",
          "fields": ["uid", "meeting_code", "creator_uid"]
        },
        "public": {
          "namespace": "test",
          "key": "TXGCbcKey",
          "fields": ["field1", "field2"]
        }
      }
    },
    {
      "id": "3",
      "conditions": {
        "company_type": "non_tencent",
        "event_code": "default",
        "source": "client"
      },
      "fields": {
        "private": {
          "namespace": "test",
          "key": "GCGbcKey",
          "fields": ["uid", "meeting_code"]
        },
        "public": {
          "namespace": "test",
          "key": "GCGbcKey",
          "fields": ["field1", "field2"]
        }
      }
    }
  ]
}

```









```
[		// 腾讯企业客户端
    {
        "condition": {
        		"source": 1,
            "event_code": "",
            "field": [
                {
                    "field_name": [
                        "corp_id"
                    ],
                    "field_value": [
                        281,
                        280
                    ]
                }
            ]
        },
        "action": {
            "public": {
                "key": "",
                "field": [
                ]
            },
            "private": {
                "key": "TXGCbcKey",
                "field": [
										meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
		"nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
		"src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails
                ]
            }
        }
    },
    // 非腾讯企业客户端
    {
        "condition": {
        		"source": 1,
            "event_code": "",
            "field": [
                {
                    "field_name": [
                        "corp_id"
                    ],
                    "field_value": [
                        281,
                        280
                    ]
                }
            ]
        },
        "action": {
            "public": {
                "key": "",
                "field": [

                ]
            },
            "private": {
                "key": "GCGbcKey",
                "field": [
meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
		"nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
		"src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails
                ]
            }
        }
    },
    // 腾讯企业后台创建会议
    {
        "condition": {
        		"source": 2,
            "event_code": "create_meeting",
            "field": [
                {
                    "field_name": [
                        "corp_id"
                    ],
                    "field_value": [
                        281,
                        280
                    ]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "field": [
											uid
                ]
            },
            "private": {
                "key": "TXGCbcKey",
                "field": [
meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
		"nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
		"src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails
                ]
            }
        }
    },
     // 腾讯企业后台其他事件且creator_corp_id 不等于 envCorpId
    {
        "condition": {
        		"source": 2,
            "event_code": "",
            "field": [
                {
                    "field_name": [
                        "corp_id"
                    ],
                    "field_value": [
                        281,
                        280
                    ]
                },
                 {
                    "field_name": [
                        "creator_corp_id"
                    ],
                    "field_value": [
                        "281",
                        "280"
                    ]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "field": [
											uid
                ]
            },
            "private": {
                "key": "TXGCbcKey",
                "field": [
meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
		"nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
		"src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails
                ]
            }
        }
    },
     // 腾讯企业后台其他事件且creator_corp_id 等于 envCorpId
    {
        "condition": {
        		"source": 2,
            "event_code": "",
            "field": [
                {
                    "field_name": [
                        "corp_id"
                    ],
                    "field_value": [
                        281,
                        280
                    ]
                },
                 {
                    "field_name": [
                        "creator_corp_id"
                    ],
                    "field_value": [
                        "281",
                        "280"
                    ]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "field": [
											uid
                ]
            },
            "private": {
                "key": "TXGCbcKey",
                "field": ["creator_uid",
meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
		"nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
		"src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails
                ]
            }
        }
    },
     // 非腾讯企业后台
    {
        "condition": {
        		"source": 2,
            "event_code": "",
            "field": [
                {
                    "field_name": [
                        "corp_id"
                    ],
                    "field_value": [
                        281,
                        280
                    ]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "field": [
											uid
                ]
            },
            "private": {
                "key": "TXGCbcKey",
                "field": [
meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
		"nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
		"src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails
                ]
            }
        }
    }
]
```

[
    {
        "condition": {
            "fields": [
                {
                    "name": "corp_id",
                    "values": [281, 280]
                },
                {
                    "name": "source",
                    "values": [1]  // 客户端
                },
                {
                    "name": "event_code",
                    "values": ["security_access_log", "create_meeting"]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": ["meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name", "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone", "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"]
            }
        }
    },
    {
        "condition": {
            "fields": [
                {
                    "name": "corp_id",
                    "values": [281, 280]
                },
                {
                    "name": "source",
                    "values": [2]  // 后台
                },
                {
                    "name": "event_code",
                    "values": ["create_meeting"]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            }
        }
    },
    {
        "condition": {
            "fields": [
                {
                    "name": "corp_id",
                    "values": [281, 280]
                },
                {
                    "name": "source",
                    "values": [2]  // 后台
                },
                {
                    "name": "event_code",
                    "values": ["security_access_log"]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": ["meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name", "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone", "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"]
            }
        }
    },
    {
        "condition": {
            "fields": [
                {
                    "name": "corp_id",
                    "values": [281, 280]
                },
                {
                    "name": "creator_corp_id",
                    "values": [281, 280]
                },
                {
                    "name": "source",
                    "values": [2]  // 后台
                },
                {
                    "name": "event_code",
                    "values": ["security_access_log"]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code", "creator_uid"]
            }
        }
    },
    {
        "condition": {
            "fields": [
                {
                    "name": "corp_id",
                    "values": [281, 280]
                },
                {
                    "name": "creator_corp_id",
                    "values": [281, 280]
                },
                {
                    "name": "source",
                    "values": [2]  // 后台
                },
                {
                    "name": "event_code",
                    "values": ["create_meeting"]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code", "creator_uid"]
            }
        }
    },
    {
        "condition": {
            "fields": [
                {
                    "name": "corp_id",
                    "values": [282, 283]
                },
                {
                    "name": "source",
                    "values": [1, 2]  // 客户端和后台
                }
            ]
        },
        "action": {
            "public": {
                "key": "GCGbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "GCGbcKey",
                "fields": ["meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name", "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone", "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"]
            }
        }
    }
]



// corp_id 企业号数组
// "SourceID"`   //来源ID来源id#枚举值：1：客户端 2：后台
// event_code 事件
// public 公参部分，key，加密密钥，fields：指定字段
// private 私参部分，key，加密密钥，fields：指定字段

```json
[
    // 腾讯企业客户端
    {
        "condition": {
            "SourceID": 1,
            "event_code": "",
            "fields": [
                {
                    "field_name": "corp_id",
                    "field_value": [1400115281]
                }
            ]
        },
        "action": {
            "public": {
                "key": "",
                "fields": []
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": [
                    "meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
                    "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
                    "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"
                ]
            }
        }
    },
    // 非腾讯企业客户端
    {
        "condition": {
            "SourceID": 1,
            "event_code": "",
            "fields": [
                {
                    "field_name": "corp_id",
                    "field_value": []
                }
            ]
        },
        "action": {
            "public": {
                "key": "",
                "fields": []
            },
            "private": {
                "key": "GCGbcKey",
                "fields": [
                    "meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
                    "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
                    "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"
                ]
            }
        }
    },
    // 腾讯企业后台创建会议
    {
        "condition": {
            "SourceID": 2,
            "event_code": "create_meeting",
            "fields": [
                {
                    "field_name": "corp_id",
                    "field_value": [1400115281]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": [
                    "meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
                    "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
                    "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"
                ]
            }
        }
    },
    // 腾讯企业后台其他事件且creator_corp_id 等于 envCorpId
    {
        "condition": {
            "SourceID": 2,
            "event_code": "",
            "fields": [
                {
                    "field_name": "corp_id",
                    "field_value": [1400115281]
                },
                {
                    "field_name": "creator_corp_id",
                    "field_value": [1400115281]
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": [
                    "creator_uid",
                    "meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
                    "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
                    "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"
                ]
            }
        }
    },
  // 腾讯企业后台其他事件且creator_corp_id 不等于 envCorpId
    {
        "condition": {
            "SourceID": 2,
            "event_code": "",
            "fields": [
                {
                    "field_name": "corp_id",
                    "field_value": [1400115281]
                },
                {
                    "field_name": "creator_corp_id",
                    "field_value": []
                }
            ]
        },
        "action": {
            "public": {
                "key": "TXGCbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "TXGCbcKey",
                "fields": [
                    "meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
                    "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
                    "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"
                ]
            }
        }
    },
    // 非腾讯企业后台
    {
        "condition": {
            "SourceID": 2,
            "event_code": "",
            "fields": [
                {
                    "field_name": "corp_id",
                    "field_value": []
                }
            ]
        },
        "action": {
            "public": {
                "key": "GCGbcKey",
                "fields": ["uid", "meeting_code"]
            },
            "private": {
                "key": "GCGbcKey",
                "fields": [
                    "meeting_subject", "subject", "nick_name", "nickname", "src_user_name", "tar_user_name",
                    "nick_name_0", "old_nick_name_0", "creator_nick_name", "phone", "phone_number", "phone-number", "tar_phone",
                    "src_phone", "phone_id_0", "email", "tar_email", "src_email", "rooms_report_issue_user_emails"
                ]
            }
        }
    }
]

```



```go
// IsTencentConfig 定义了腾讯企业配置结构体
type TencentCorpIdsConfig struct {
	CorpIDs []string `json:"corp_id"` // 企业ID列表
}

func NewTencentCorpIdsConfig() *
```



```go
1.// TestCorpsConfig ...
type TestCorpsConfig struct {
	Corps    []string `json:"corps"`
	CorpsMap map[string]struct{}
}
2.// NewTestCorpsConfig 新建TestCorpsConfig
func NewTestCorpsConfig() *TestCorpsConfig {
	return &TestCorpsConfig{
		Corps:    make([]string, 0),
		CorpsMap: make(map[string]struct{}),
	}
}
3.// fetchTestCorpConf 获取测试企业配置
func fetchTestCorpConf() (*TestCorpsConfig, error) {
	// 计数器增加，用于监控函数调用次数
	metrics.IncrCounter("fetchTestCorpConf.total", 1)

	// 从配置中心获取 "test_corps" 配置
	resp, err := config.Get("client-report").Get(trpc.BackgroundContext(), "test_corps")
	if err != nil {
		// 如果获取配置失败，计数器增加，用于监控错误次数
		metrics.IncrCounter("fetchTestCorpConf.err", 1)
		log.Errorf("get test_corps failed: %v", err)
		return NewTestCorpsConfig(), err
	}

	// 创建新的 TestCorpsConfig 结构体实例
	testCorpsConf := NewTestCorpsConfig()
	// 将配置中心返回的 JSON 字符串反序列化为 testCorpsConf
	if err := json.Unmarshal([]byte(resp.Value()), &testCorpsConf); err != nil {
		// 如果反序列化失败，计数器增加，用于监控错误次数
		metrics.IncrCounter("fetchTestCorpConf.err", 1)
		log.Errorf("Unmarshal failed: %v", err)
		return NewTestCorpsConfig(), err
	}

	// 将 Corps 列表中的企业 ID 添加到 CorpsMap 字典中
	for _, corpID := range testCorpsConf.Corps {
		testCorpsConf.CorpsMap[corpID] = struct{}{}
	}
	// 返回配置和错误信息
	return testCorpsConf, nil
}
4.// loadTestCorpConf ...
func loadTestCorpConf() error {
	testCorpConf, err := fetchTestCorpConf()
	if err != nil {
		metrics.IncrCounter("loadTestCorpConf.failed", 1)
		return err
	}
	SetTestCorpsConf(testCorpConf)
	metrics.IncrCounter("loadTestCorpConf.ok", 1)
	log.Infof("loadTestCorpConf success, corps=%d", len(testCorpConf.Corps))
	return nil
}
5.// InitTestCorpConf ...
func InitTestCorpConf() error {
	// 第一次加载配置文件
	err := loadTestCorpConf()
	if err != nil {
		return err
	}
	// 监控配置文件的变化
	rch, _ := config.Get("client-report").Watch(trpc.BackgroundContext(), "test_corps")
	go func() {
		defer func() {
			// 捕获和处理可能的 panic
			if r := recover(); r != nil {
				log.Errorf("watch test_corps panic, err=%v", r)
				metrics.IncrCounter("InitTestCorpConf.panic", 1)
			}
		}()
		// 监听配置文件变化
		for rsp := range rch {
			log.Infof("test_corps changed, event_type=%v, response=%s", rsp.Event(), rsp.Value())
			// 配置文件变化时重新加载配置
			loadTestCorpConf()
		}
	}()
	return nil
}
6.// IsTestCorp 是否是测试企业
func (o *TestCorpsConfig) IsTestCorp(appID string) bool {
	_, ok := o.CorpsMap[appID]
	return ok
}
7.// GetTestCorpsConf 获取测试企业配置
func GetTestCorpsConf() *TestCorpsConfig {
	ptr := (*TestCorpsConfig)(atomic.LoadPointer(&testCorpsConfPtr))
	if ptr == nil {
		return &TestCorpsConfig{}
	}
	return ptr
}
8.// IsTestCorp 是否是测试企业
func IsTestCorp(corpID string) bool {
	return GetTestCorpsConf().IsTestCorp(corpID)
}
```





#### `json.Unmarshal` 的功能

`json.Unmarshal` 函数将 JSON 字节数据解析为 Go 语言的数据结构。在这里，它的作用是将从配置中心获取到的 JSON 数据解析到 `testCorpsConf` 变量中。

#### 解析过程

假设 `resp.Value()` 返回的 JSON 数据如下：

```
json
复制代码
{
  "corps": ["1400143280", "1400212767"]
}
```

对应的Go结构体如下：

```
go
复制代码
type TestCorpsConfig struct {
	Corps    []string `json:"corps"`
	CorpsMap map[string]struct{}
}
```

在调用 `json.Unmarshal` 后，解析过程如下：

1. **检查数据类型匹配**： `json.Unmarshal` 确保 JSON 数据的结构与 `TestCorpsConfig` 结构体的字段类型匹配。即：
   - JSON 对象中的 `corps` 字段应该是一个字符串数组。
2. **解析 JSON 数据**： `json.Unmarshal` 逐个解析 JSON 数据中的字段并将其映射到 `TestCorpsConfig` 结构体中相应的字段：
   - JSON 中的 `"corps": ["1400143280", "1400212767"]` 会被解析并赋值给 `testCorpsConf.Corps` 字段。
3. **填充结构体**： `testCorpsConf.Corps` 被填充为 `[]string{"1400143280", "1400212767"}`。
4. **额外处理**： `CorpsMap` 字段需要手动填充，这在后续代码中通过遍历 `Corps` 列表完成：

```
go
复制代码
for _, corpID := range testCorpsConf.Corps {
	testCorpsConf.CorpsMap[corpID] = struct{}{}
}
```

### 



<img src="/Users/giffinhao/Library/Application Support/typora-user-images/image-20240807191525848.png" alt="image-20240807191525848" style="zoom:50%;" />
