# MRtrix3：一个快速、灵活和开放的医学图像处理和可视化软件框架

MRtrix3是一个开源、跨平台的医学图像处理、分析和可视化软件包，特别强调使用弥散磁共振成像对大脑进行研究。
它是使用快速、模块化和灵活的通用代码框架实现的，用于图像数据访问和操作，支持高效开发新应用程序，同时保持高计算性能和应用程序之间一致的命令行界面。
在本文中，我们对MRtrix3框架的功能和软件提供的通用图像处理应用程序进行了高层次的概述。

在过去的几十年里，磁共振成像(MRI)等医学成像技术的使用迅速扩大，引发了针对这些通常是大型(3维甚至更高维)的成像数据集的专用数字图像分析技术的发展(Dhawan，2011)。
这些方法包括伪影校正、解剖分割、定量特征提取和空间图像配准，空间图像配准允许随时间比较受试者中的特征、受试者(组)之间和跨人群的特征。
医学图像分析技术的发展在很大程度上是由学术研究界推动的，许多这样的软件包现在是免费的，包括：FSL(Jenkinson等人，2012)、Freesurfer(Fischl，2012)、SPM(Ashburner，2012)、Afni(Cox，1996)、DTI Studio(酱等人，2006)、DSIStudio(“DSI Studio”2019)、Camino(Cook等人，2006)、DevelopreDTI(Leemans等人，2009)、MITK(Nolden等人，2013)、ITK(Yoo et al.，2002)、Ants(Avants等人，2009)。
MIRTK(“MIRTK”2019)、DiPy(Garyfallidiset al.，2014)和许多其他公司。
这样的开放软件平台有可能将新方法的开发转化为例如MRI硬件供应商、临床医生和生物医学研究社区。MRtrix3被设计为用于医学图像分析和可视化的开源、模块化软件平台。
这包括用于应用程序开发的轻量级框架，该框架可促进高效的图像访问和操作、方便的多线程基元，以及对广泛的图像文件格式的支持。
MRtrix3提供的终端用户应用程序包括通用图像转换和处理工具，以及为多维(3D)医学图像数据量身定做的可视化工具MRView。
所有组件的设计都非常注重性能和内存效率，这是处理这些通常非常大的数据集的基本功能。
对计算要求很高的定量成像算法通常需要几分钟(或几小时)的运行时间，如果没有针对这一点进行性能优化，运行时间可能很容易变成几天(或几周)。
此外，MRtrix3还支持可以独立构建和分发的外部模块。MRtrix3的开发历史上特别强调使用扩散加权磁共振成像(DMRI)来研究脑白质，扩散加权磁共振成像是一种医学成像方式，可以通过测量局部水扩散障碍来间接探测神经微结构(Johansen-Berg和Behrens，2013；Jones，2010)。
它源于现在不推荐使用的MRtrix 0.2.x软件包(Tournier等人，2012)，该软件包大约在2003年左右开始使用，当时几乎没有适用于

磁共振弥散成像数据分析。
自那以后，无论是在底层代码库的内部，还是在所提供的功能范围方面，它都发生了巨大的变化。
该平台结合了许多针对每个成像体素内的dMRI数据的定向性质的特征，例如使用球谐基函数的表示，以及用于3D流线的定制文件格式。MRtrix3还提供了广泛的dMRI分析方法，在下面的扩散分析部分中概述。
由于这些功能，MRtrix3在dMRI社区中获得了初步的支持。
然而，它的体系结构总体上有利于图像处理，并且MRtrix3还提供了不太具体的图像分析方法，例如滤波和计算、统计、图像去噪(Veraart等人，2016)和吉布斯振荡抑制(Kellner等人，2016)、强度归一化(Raffelt等人，2007a)和差纯图像配准(Raffeltet等人，2011)。
我们概述了软件体系结构的主要方面，特别是映像访问和多线程原语，以及构建系统和相关的开发工具。
最后，我们展示了MRView中的可视化功能，并简要概述了目前支持的通用图像处理和dMRI分析工具。
指导原则2.1。
随着越来越多的神经影像研究和先进的数据分析在放射学实践中的日益普及，重复性变得越来越重要。
发布开放和可重现的分析管道使神经科学研究能够在更大的数据集上复制实验结果，还有助于比较各种方法的敏感性和特异性。
此外，公开可用的软件可以帮助新的分析技术的临床翻译。MRtrix3集体认为，可重复使用的神经科学首先依赖于开源软件。
发布源代码，跟踪版本，记录改进和错误修复，对于确保研究中所做工作的完全透明至关重要。
因此，我们完全致力于保持MRtrix3的开源，并使用Git跟踪版本历史。
该软件是根据开源Mozilla公共许可证2.0，1的条款发布的，只要公开源代码，就允许第三方修改、分发和商业使用(尽管根据原始作者的要求，可以在不同的版权许可证下发布单独的命令)。
此外，MRtrix3还纳入了持续的集成测试，以检测和避免版本之间代码更改的不利影响。此外，MRtrix3提供了处理脑成像数据结构(BIDS)中的数据所需的功能，2这是最近提出的组织和共享神经成像数据的标准(Gor-Golewski等人，2016)。
其中包括以JSON和FSLbves/bvals格式导入和导出dMR I渐变编码和其他元数据，最终实现在投标应用程序中集成MRtrix3命令(GorGolewski等人，2017)。**最后，MRtrix3还在输出文件头中提供自动历史跟踪，存档用于生成每个输出图像的操作流水线，以及每个调用的命令的确切版本标签**

用户文档可以在每个命令的内联帮助页面中找到，也可以在包含其他背景信息、教程和管道的专用文档网站3上找到。
文档与当前版本保持最新，并且可以检索较旧版本的文档。
主要更新和新软件发布也会在主网站和博客上公布。4开放开发的另一个关键好处是用户和开发人员作为一个社区之间的互动。
为了促进这些互动，MRtrix3提供了一个在线论坛，5在这里，越来越多的用户可以提出问题、获得支持和进行科学讨论。此外，用户和开发人员可以通过Github，6报告和跟踪技术问题，并为未来版本的新功能提出建议。
GitHub也是讨论和管理内部和外部开发人员内容的平台。
设计方面MRtrix3从一开始就被设计为促进与医学图像数据集的处理和分析有关的高性能应用程序的开发，并提供一致和简单的命令行界面。
它主要侧重于命令行应用程序，以提供广泛的功能，这些功能可以组合在一起并编写脚本以形成复杂的自动化工作流。
它依赖于现代标准和技术，特别是C Tower 117和OpenGL83.3，但它努力将外部依赖的数量限制在一个小的、支持良好的集合，可以在广泛的平台上使用；目前这些平台包括Python9(用于构建软件和使用脚本)、zlib10(用于访问压缩图像)、Eigen 311(用于高性能线性代数支持)和Qt12(版本4或5，用于图形用户界面支持)。
所有这些依赖项都可以在广泛的平台上使用，允许MRtrix3在Unix的最新版本上本地运行，包括GNU/Linux和MacOS以及各种高性能计算(HPC)环境，并通过MSYS213项目或Windows Subsystem for Linux(WSL)运行Micro-soft Windows。14大部分功能是使用C塔模板编写的，通过允许编译器优化任何冗余开销来提供高运行时性能。
基于对多维图像访问的高度关注，提供了用于多线程操作的简单而强大的结构。
**该框架提供对医学成像社区中常用的一系列图像文件格式的本机访问和无缝交互，包括对DICOM 15(只读)、Analyze，16NIfTI1，17NIfTI2，18MGH，19andMRtrix3’s自己的专用图像格式20以及压缩格式的本机支持**

**MRtrix引入了一些额外的文件格式来处理各种类型的数据，特别是图像数据，并简化了数据。**
这些特定于eMRtrix的格式旨在解决当时可用格式中的限制，并提供其他好处，包**括：在标题中存储任意键值条目的能力，这使得能够存储扩散梯度和相位编码方案或任何其他被认为感兴趣的元数据，避免由于混合存储在多个文件(例如，bves/bvals文件)中的数据而导致的潜在误差源；跟踪命令历史；能够以任意步长存储数据(在下文和附录A中讨论)；**
**简化存储在扫描仪空间中的数据，消除对外部参考图像的任何依赖。我们注意到上面列出的优点在今天仍然适用，因此，我们仍然向用户推荐使用这些格式。**
这两种格式都有可供使用的参考matb21代码记录。MRtrix3还提供了用于导入和导出格式之间的流线型数据的检查转换工具。虽然大多数MRtrix3命令由编译的二进制可执行文件组成，但也有一些是用Python编写的，通常会调用其他MRtrix3可执行文件来执行更复杂的任务。
此外，许多脚本调用来自第三方软件包的命令，例如FSL(Jenkinson等人，2012)或ANTS(Avants等人，2009)，提供方便的包装器来执行专门任务(有关详细信息，请参阅下面的图像处理工具和分析部分)。
图像访问图像输入/输出的功能由核心MRtrix3库提供，因此所有MRtrix3应用程序都可以直接读写所有支持的图像格式：不需要将数据转换为特定的图像格式。
所有MRtrix3应用程序始终使用相同的坐标系，这与Nifti标准中的扫描仪参考帧相同。MRtrix3处理跨文件格式一致的坐标，此外，本机MRtrix3图像格式允许自动处理和存储与坐标系相关的信息，例如图像标题中的dMRI梯度表，以确保该信息在整个分析流水线中保持一致。然而，我们注意到，尽管MRtrix3支持这些格式，但软件包之间的互操作性仍可能存在问题，主要与假定的关于存储信息的解释的约定有关，例如：方向、张量分量、球面调和系数和其他类型的信息(例如，存储EI基因向量时假定的坐标系等)。
在社区就共同标准达成一致之前，用户将需要手动处理因这些差异而产生的任何问题。

3.1.1。
**优化的数据访问使用各种技术自动优化对图像数据的访问，以确保在一系列操作条件下具有接近最佳的性能。**
**本节概述了采用的各种策略。默认情况下，映像访问是通过动态数据类型转换的内存映射实现的。**
然而，**当存储的数据类型与应用程序请求的数据类型匹配时，MRtrix3命令将自动使用“直接IO”访问**，其中数据在内存中作为ANative数组访问，从而避免了转换所需的函数调用的开销。
当需要时，应用程序还可以显式地请求对数据的“直接IO”访问(例如，如图所示。
1)：这对于将重复访问数据的应用程序特别有利，例如，多遍算法、基于补丁的操作、内插等。为了实现这一点，数据以所需的数据类型直接加载到RAM中，除非它们已经这样存储(在这种情况下，存储器映射已经提供了“直接IO”访问)。
此外，虽然图像写入通常也是使用内存映射完成的，但在某些情况下，这样做会导致性能下降。
在网络文件系统上操作时，这一点尤其重要，在这些系统中，对内存映射区域的随机写入可能会导致网络使用率很高。
在这种情况下，MRtrix3使用交替延迟回写策略，后端将数据保存在RAM中，并在图像关闭时自动将数据提交到存储。MRtrix3还具有灵活的跨度概念，允许以任何合理的顺序将多维图像数据存储在RAM(或图像格式支持的文件)中(有关详细信息，请参阅附录A)。
例如，完全有可能以卷连续的方式存储数据(对于4D文件)，这意味着给定成像体素的所有体积的数据共同位于RAM中(参见图3)。
A1)。
这允许高效访问并最大限度地利用CPU缓存，在某些情况下显著提高了性能。
开发人员可以在考虑到特定目的(例如，4D文件的体素处理)访问图像时指定这些步长，MRtrix3后端将在必要时加载并重新排序RAM中的图像数据，但仍使用通过内存映射的“直接IO”访问，以尽可能避免不必要的数据复制。
图像可以以CHOSENFILE格式支持的任意步长顺序存储。
在支持的格式中，只有MRtrix3自己的格式支持任意跨距排序，这一功能在处理不同类型的数据时提供了明显的性能优势，特别是通过允许卷连续存储

**DICOM处理MRtrix3包括其自己的快速DICOM导入处理，允许所有MRtrix3应用程序无缝地支持DICOM图像作为输入。**
DICOM导入代码处理使用最新的DICOM多帧标准存储的数据，以及标准的多文件存储，包括西门子马赛克。
如果存在，它还将提取3个主要供应商(西门子、通用电气、飞利浦)的扩散磁共振编码信息，并将其作为图像标题的一部分提供给应用程序。
如果找到其他类型的信息，还可以提取其他类型的信息，包括EPI阶段编码方向和切片计时。DICOM图像可以作为单个.dcm文件提供，或者更多，作为包含组成整个DICOM系列的多个DICOM文件的文件夹提供。
导入代码将扫描文件夹中的所有文件，递归到遇到的任何子文件夹中，并按患者/研究/系列/图像将所有信息整理到一个层次结构中。
如果文件夹包含单个DICOM系列，则数据将作为单个数据集直接加载，无需进一步交互；否则，将向用户显示内容列表，并要求用户选择所需的系列

性能和管道3.2.1。
Unix管道MRtrix3允许在RAM中创建临时映像，以使用应用程序内的缓存，也可以通过Unix管道在应用程序之间传递。
这允许软件使用不灵活、功能强大的组合，例如：不是通过管道传递完整的图像数据，而是创建临时映像来保存数据，并且只通过管道传递文件名。
这有助于确保最佳性能，因为可以通过管道两端的内存映射访问数据，消除任何不必要的数据副本，并将RAM使用率保持在最低水平。
**多线程多线程是一种由现代硬件支持的计算机执行技术，它允许程序同时跨多个执行线程运行。**
**每个线程独立执行，同时共享其资源并与进程中的其他线程协调。**
**在MRtrix3中，几乎所有的命令都是多线程的，默认情况下以最大限度地利用CPU处理器来实现高计算性能。在MRtrix3中，多线程处理主要通过使用两个应用编程接口(API)之一来实现：1.图像处理**：当图像(或图像集合)的子集(例如体素、切片、体积)可以被独立处理时，线程循环构造执行图像的多线程遍历，唯一的必要条件是程序员定义要为每个图像位置执行的函数；如图3所示。
2并在附录B中使用。并发线程通常会处理相邻的数据行；这样做是为了确保最佳性能，方法是最大化高速缓存重用、最小化磁盘寻道延迟，并保持足够精细的粒度以避免空闲的CPU核心。默认情况下，映像轴的遍历顺序由映像的条纹设置，尽管这可以由开发人员根据需要明确指定。
此外，开发人员可以控制同时循环哪些图像、迭代哪些轴以及在每个线程内处理哪些图像(默认情况下为单行)。**2.一般处理：对于图像网格以外的任务，更通用的run_Queue()结构通过使用数据队列结构启用多线程处理**；图中显示了这方面的一个示例。
**3.程序员定义的类通过函数器从这些队列读取和/或写入数据，并在API后端处理的线程之间进行必要的互斥锁定。**
在这些线程之间传递的数据类型也是模板化的，因此完全由程序员控制。
对于较小的数据/处理任务，可以成批聚合这些数据的实例，以减轻线程间通信的开销。
在高性能计算环境中使用MRtrix3可以在HPC环境中运行：它既可以由系统管理员在系统范围内安装，也可以由用户自己安装到单独的用户帐户中，并提供对系统范围、用户特定和命令特定级别的线程数量和临时文件位置等方面的控制。
为了简化在带有过时编译器或其他依赖项的较旧HPC系统上的安装，MRtrix3提供了编译静态构建的选项，这些构建可以在独立的最新工作站上生成，并在编译后传输到HPC。虽然通过容器支持虚拟化不在



![截屏2022-09-20 17.24.11](/Users/haozhipeng/Library/Application Support/typora-user-images/截屏2022-09-20 17.24.11.png)

演示了使用MRtrix3软件库从文件系统访问映像时，在一行代码中提供的功能





2.多线程图像处理的ThreadedLoopConstruction演示。
参考图像(在这种情况下为输入)和/或轴选择确定循环将在其上迭代的图像区域(绿色向量)，可选地显示具有所提供的文本的进度条。
PRO-Grammer编写了一个函数器类(蓝框)，它有一个运算符，打算分别应用于每个图像元素。循环构造根据需要自动复制函数器类的实例，每个执行线程一个实例(在本例中为两个)。
这些线程中的每一个都将在图像的唯一部分(默认情况下是一行体素)上循环，循环结构为循环中涉及的所有图像(在本例中为“输入”和“输出”)设置每个函数器调用之前的索引位置。![截屏2022-09-20 17.37.07](/Users/haozhipeng/Library/Application Support/typora-user-images/截屏2022-09-20 17.37.07.png)

演示了用于通用多线程处理的run_Queue()构造。
每一个源、管道和宿类都定义了一个函数器，该函数器用队列结构管理线程之间的数据传输，该函数器读取和/或写入特定的数据实例。
在这个特定的例子中，要求管道类是多线程的，这导致了管道类的多个实例，每个实例都将由后端配置为操作来自第一个队列的数据1类的唯一实例，并将数据2类的唯一实例写入第二个队列。
任何类都可以通过相应函数器的返回值随时终止多线程处理。
这类队列在MRtrix3中被广泛用于处理非图像数据，例如流水线：例如，‘源’可能从文件中读取流线数据，‘管道’可能独立地对每个流线执行某些操作(例如重采样)，而‘宿’可能将它们写回文件![截屏2022-09-20 17.41.09](/Users/haozhipeng/Library/Application Support/typora-user-images/截屏2022-09-20 17.41.09.png)



3.3.。
开发人员工具MRtrix3是使用现代软件实践开发的，并考虑到了透明度。
使用Git管理软件版本控制，托管在Github上。25在GitHub上跟踪和公开讨论问题。26MostMRtrix3命令进行测试，以确保在整个开发周期中输出结果与预期一致。测试数据托管在单独的Git库27上，以保持主源代码库的规模和轻量级。
持续集成测试由TravisCI28(用于Linux和MacOS)和AppVeyor 29(用于Microsoft Windows)管理。MRtrix3旨在最大限度地减少开发完整图像处理应用程序所需的工作量，如图所示。
1-3.开发人员可以使用一系列类来无缝访问图像和其他类型的数据、对图像进行多线程操作以及并行处理数据流、图像过滤器和其他方便的方法。
核心API文档可在网上30获得，并使用Doxgen直接从代码生成。31开发工具和构建系统在附录B中演示(其他示例可在开发人员文档32中找到)。
B.1中的二进制命令示例还说明了MRtrix3库3.3.1中提供的图像访问和多线程原语。
集成的命令行界面和文档MRtrix3提供了一个框架，用于同时记录、指定和检索命令行参数和选项，所有这些都集中在每个应用程序的单个功能中。
这包括作者和版权信息，命令的一般描述和参数和选项的具体描述，以及任何相关参考。
这些信息用于生成应用程序的在线帮助页面，并在运行时显示其帮助页面，以自动检查参数的有效性，并在代码中的任何位置检索这些参数和选项。
有关此框架的说明，请参阅附录B中的代码示例。3.3.2。
构建系统该软件包括一个定制系统，用于管理、配置和构建软件。
它由两个Python脚本组成：‘CONFigure’和‘Build’。
前者检测操作环境的各个方面(OS、兼容C？11的编译器和所需库的可用性等)。
构建脚本扫描代码以基于有关文件位置和命名约定的简单规则构建完整的依赖关系树，识别过时的目标，汇编使目标保持最新所需的任务列表，然后以正确的顺序并行启动相关命令，以加快构建速度。
这允许修改代码，而不需要任何其他更改(例如，更改外部生成文件)：只需将新命令拖放到正确的文件夹中，并在下次调用构建时编译其对应的二进制文件。

3.3.3。
外部贡献MRtrix3鼓励用户向软件贡献他们自己的方法，并认识到他们需要分发这些方法，无论他们看到什么。
因此，MRtrix3构建系统为外部模块提供了一个方便的原语，使开发人员能够构建他们自己的应用程序，链接到核心MRtrix3库，并利用其图像访问和多线程原语。
这些外部模块可以在任何开源许可下单独分发，也可以集成到一个MRtrix3版本中。
在这两种情况下，通过在代码和生成的命令帮助页面和文档中嵌入作者信息、参考资料和版权声明，开发人员的工作得到了充分的认可。
Python脚本虽然图像管道(如Unix管道(第3.2.1节)中所述)可用于将几个MRtrix3命令链接到复合应用程序中，但MRtrix3还包含专用的Python脚本库，以帮助开发更复杂的应用程序和处理涉及多个MRtrix3(或其他)命令的流水线。与DiPy(Garyfallidis等人，2014)等项目不同，该库不提供在Python本身内操作原始图像数据的功能，但提供调用和管理外部高性能可执行文件以执行实际计算的功能。
脚本库的功能包括：标准的命令行选项；帮助页面格式和文档生成与MRtrix3二进制命令一致；临时目录管理；以及从先前执行的任何点继续执行长时间或计算要求高的流水线的能力。构建这些脚本的应用程序模块和库函数被额外设计为既可访问又可用，供希望从现有命令构建自己的处理流水线并与外部工具接口的研究人员使用，其中所述的功能在“3.3.3外部贡献”中描述的功能适用于此类脚本，就像适用于C塔二进制文件一样。
附录B.4中提供了此类脚本的一个示例。
**MRView是为跨平台、高性能、使用方便、可扩展而编写的。**
为了实现这些目标，MRView使用高性能行业标准OpenGL333.3 API来利用现代系统的图形功能，并使用广泛支持和开源的Qt工具包34来管理界面元素(窗口小部件)。
它还从一开始就设计用于从命令行交互使用。
这允许用户快速尝试新的想法，开发和调试流水线，并检查处理命令的输出。
其设计的两个方面对此起到了支持作用：第一，MRView接受来自Unix管道的输入(如第3.2.1节的示例中所示)；第二，它快速启动和显示(通过许多设计决策，包括使用内存映射进行“延迟加载”和将界面元素的初始化延迟到使用点)。
有关演示视频，请参阅MRtrix3网站。35 MRview的一个重要方面是它能够同时加载多个图像，允许通过菜单或PageUp/PageDown键在它们之间进行快速切换。
与上述优化相结合，这允许在其他需要的工作流程中交互使用，例如同时将一长串图像加载到查看器中，并使用交互帧速率检查它们，即使数据保存在网络文件共享上。
**这种类型的操作对于快速扫描大型研究中所有参与者的处理步骤的结果非常有用(例如，检查图像蒙版的质量)。MRView还能够以任意倾斜的方式显示数据的切片信息。**
这对以下方面特别有用

例如，在其最合适的解剖环境中显示通过纤维束造影术获得的流线等特征。
在所有查看模式下都可以使用离轴渲染(见下文)。MRView还可以处理高维图像，目前最高可达5D。通过箭头键、菜单或查看工具(见下文)，可以简单快速地在卷(第4维)或卷组(第5维)之间进行导航。MRView的一个核心原则是，内容始终以扫描仪坐标显示在正确位置，而不是相对于图像坐标。
这适用于主图像，但也适用于叠加和流线，以及任何方向信息，如矢量或方向密度函数(ODF)。
这允许同时显示不同类型的数据，而与这些数据是如何产生的无关。例如：即使图像的体素大小和/或方向不同，图像也可以叠加在一起；由光道造影术产生的流线可以显示在用于产生它们的图像之外的其他图像上(例如，共同配准的解剖图像)；无论当前显示的图像是什么，ODF或矢量都将指向预期的方向；等等。
4显示了包含渲染模式的MRView的屏幕截图。这些模式由许多提供附加特定功能的独立工具补充。
其中包括：查看：提供对显示的一般方面的精细控制，如亮度/对比度、十字准线的位置，以及访问特定模式的设置，如体积渲染的剪裁平面







MR在体积渲染模式下，显示具有3个剪切面的解剖T1加权MRI，感兴趣区对应于使用覆盖工具(以绿色)划线的运动，以及通过纤维束成像工具显示的概率流线描绘皮质脊髓束。J.-D.Tournier等.NeuroImage202(2019年)1161377![截屏2022-09-20 18.50.30](/Users/haozhipeng/Library/Application Support/typora-user-images/截屏2022-09-20 18.50.30.png)





叠加：在主图像上叠加附加图像，可控制色彩图、透明度和阈值。ROI编辑器：提供一个编辑二进制掩模图像的界面。**跟踪图：可视化跟踪图输出，具有流管渲染选项。**ODF渲染器工具：方向密度函数(图5)的可视化，提供为球面调和系数、沿ASET离线方向(‘dixels’36)的样本或张量系数。Fixel PlotTool：显示体素方向的矢量，提供为X、Y、Z系数的4D图像或使用MRtrix3的稀疏固定值存储





图5.使用3种组织类型的多组织约束球形去卷积结果：WM-(蓝色)、GM-(绿色)和CSF样(红色)隔室，覆盖WM纤维取向分布(浅蓝色)![截屏2022-09-20 18.55.02](/Users/haozhipeng/Library/Application Support/typora-user-images/截屏2022-09-20 18.55.02.png)





使用MRView的Fixel Plot工具显示了一个基于像素的分析结果的示例。
这个例子显示了运动神经元疾病患者和健康对照组之间的像素比较，使用了基于连接性的固定增强。
第一行：Fixels是间接编码的颜色，红色：左-右，绿色：前-后，蓝色：下-上。
最下面一行：固定物的颜色是基于家族性误差校正的p值，突出显示患者组中有显著纤维密度丢失的固定物。![截屏2022-09-20 18.56.14](/Users/haozhipeng/Library/Application Support/typora-user-images/截屏2022-09-20 18.56.14.png)

参见(Raffelt等人，2007b)对Fixel概念的描述。ConnectomTool：使用各种技术(图7)可视化通过连接分析获得的节点和边缘。屏幕捕获工具：使用广泛支持的开源便携式网络图形(PNG)格式将主显示的内容写入文件。38这还允许创建电影(例如参见MRtrix3网站上的演示视频，以及(Mito等人，2018)提供的补充材料)。
图像处理工具和分析MRtrix3与一系列终端用户应用程序捆绑在一起，用于执行通用图像操作和复杂分析，重点放在扩散MRI.MRtrix3命令名称遵循一个惯例，以反映命令的目的并有助于发现。
首先，为主要的数据类型定义了一组速记的“代码”。
它们在命令名本身中直接指示命令所操作的数据的类型；例如，用于通用(磁共振)图像的“mr”，用于扩散加权图像的“dvi”和用于轨迹的“tck”。使用这些格式，存在两种标准化的命令名格式：“data操作”，其中输入到命令的数据类型和要执行的操作被连接；例如，“mrConvert”用于将图像转换成不同的格式，或“mrinfo”用于提供关于图像标题的信息。“Data2Data”，其中命令涉及从一种类型的数据到另一种类型的数据的某种形式的转换；例如，“warp2metric”用于从空间扭曲(变形场)计算不同的度量

生成结构连接体矩阵，并随后使用MRView连接体工具进行可视化。
来自一系列数据/软件来源的大脑切片可以与使用MRtrix3的高级脑束成像方法生成的全脑示意图相结合，以产生一个连接矩阵，该矩阵封装了每一对大脑区域之间的连接测量；MRView连接组工具提供了一系列功能，用于显示和导航连接组数据和/或基于网络的统计推断的结果![截屏2022-09-20 19.02.33](/Users/haozhipeng/Library/Application Support/typora-user-images/截屏2022-09-20 19.02.33.png)



5.1.。
**基本图像操作MRtrix3提供了一套命令，用于执行各种常见的图像数据操作。**
**每个命令都很小，但功能强大，而且是模块化的。**
这允许执行广泛的常见处理任务，同时为用户提供最大的灵活性。
这些基本命令包括：查询图像标题信息(MRINFO)；在图像格式之间转换，包括数据排除/轴置换/标题操作(MRCONVERT)；沿任意维度连接图像(MRCAT)；体素图像计算器，允许简单和复杂的数学表达式(MRCALC)；计算汇总统计(例如，平均值、STD)。
开发人员等)。
跨不同图像或沿图像轴(Mrath)；以及生成感兴趣区域内图像强度的汇总统计(Mrstats)。
扩散分析MRtrix3包括从开始到结束进行不同类型扩散分析的工具。
**特别是，它包括用于预处理、体素级建模、纤维跟踪和连接学以及GroupWise分析的最先进的工具。**
目前包括在MRtrix3中的主要技术如下：预处理工具：MP-PCA去噪(Veraart等人，2016)；去除Gibbs振铃伪影(Kellner等人，2016)；FSL工具的便利包装器，以执行运动、涡流和磁化率引起的失真校正(Andersson等人，2017、2003；Andersson和Sotiropoulos，2016)；以及基于ANTS N4(Tustison等人，2010)或FSL(Smith等人，2004；
体素水平建模：扩散张量成像(DTI)(Basseret等人，1994；Veraart等人，2013)；用于单组织纤维ODF估计的约束球面去卷积(CSD)(Tournier等人，2007,2004)和用于多壳数据的多壳多组织CSD(Jeurissenet等人，2014)，由几个响应函数估计算法支持(Dhollander等人，2019,2016；Tax等人，2014；
Tournier等人，2013)(图5)。示踪和连接学：使用DTI(Mori等人，1999)或fODF(Tournier等人，2012)的**确定性示踪示踪**；通过野生引导使用DTI(Jones，2008)或fODF采样的**概率示踪**(Jones，2008)或fODF采样(Jeurissen等人，2011；Tournier等人，2012,2010)；多壳多组织整体示踪(Christian aens等人，2015)；解剖受限的示踪(Smith等人，2012)；
球面反卷积有助于过滤轨迹图(SIFT)(Smithet等人，2013)及其较新的SIFT2变体(Smith等人，2015)；支持连通分析的工具，包括基于网络的统计(NBS)(Zalesky等人，2010)及其无阈值变体(Vinokur等人，N.D.；Baggio等人，2018)。分组图像分析：ODF图像的微分同胚配准和构建种群模板(Raffelt等人，2011)；使用置换测试的基于体素的分析(Anderson和Rob-inson，2001；
Winkler等人，2014)和无阈值集群增强(Smith和Nichols，2009)；以及基于Fixel的分析(Raffelt等人，2007b)，使用基于连接性的Fixel增强(Raffelt等人，2015)。可视化和地图：张量的方向编码颜色(DEC)地图(Pajevic和Pierpaoli，1999)和FODF(Dhollander等人，2015b)；全色锐化(Dhollander等人，2015a)和流明-南校正(Dhollander等人，2018)；
轨道密度成像(TDI)(Calamante等人，2010年)、轨道加权成像(TWI)(Calamante，2017)和轨道定向密度成像(Todi)

5.3.。
典型运行时间下面提供了处理常规临床实践中可能获得的非典型多层扩散磁共振数据集所需时间的细目。
输入数据取自B.A.T.M.A.N.T.M.A.N教程。39这些数据是在配备64通道接收器磁头线圈的西门子Prisma 3T上采集的，包括高分辨率结构(TE/TRá3.67/1910 ms，9翻转角度，256 x 256矩阵，1 mm各向同性体素，160个切片，采集时间：5分钟)和多壳dMRI采集器(tr/TE 8500/110 m，s。
2.5 x 2.5，2.5 mm 3体素，96 x 96矩阵，60个切片，3个PE反转的0卷)，分别以15，17，31，50卷的速度采集，总采集时间为17分钟。处理在运行64位Arch Linux的标准台式机系统上执行，规格如下：Intel(R)Core(TM)i7-4930 K CPU，6核超线程，3.40 GHz 32 GB RAM(4，8 GB DDR3 DIMM)NVIDIA GeForce GTX 780(3 GB RAM，
2304个CUDA核心)整个管道的总运行时间为52分钟，每个命令的细分如表1.6所示。
结论和未来方向MRtrix3从一开始就被设计为一个框架，以开放和可重复科学的原则为指导，开发和传播高性能的成像研究应用程序。
我们在未来几年的努力将集中在三个主要领域：继续在我们的专业领域提供最有希望的分析方法的高性能实施。
我们相信这是我们的用户选择使用MRtrix3的主要原因，也是该项目背后的主要动机之一。
虽然目前这主要集中在扩散磁共振上，但我们希望通过我们自己的研究和外部合作来扩大MRtrix3的应用范围

鼓励神经成像用户采用该软件，作为一套通用工具，并专门用于高级扩散磁共振分析。
到目前为止，MRtrix3的用户群主要是通过口碑传播增长的，特别是在我们在MRtrix3论坛上的活动支持下。
我们打算通过额外的教程、常见任务的视频演示、动手软件研讨会和扩展的用户可编辑的常见问题部分来扩展这一点。鼓励在神经成像社区的C塔开发人员中使用MRtrix3库。
MRtrix3API从一开始就被设计成相对独立于领域，并允许快速开发新的分析方法，只需几行代码。
因此，我们热衷于看到它被其他领域的研究人员使用，并围绕它培养一个充满活力和蓬勃发展的开发人员社区。
这将需要付出更多的努力来提供指导，记录API的所有方面，并持续支持C塔开发人员。因此，MRtrix3将继续发展工具集，并由MRI研究人员和为他们培育一个支持社区。
虽然MRtrix3的重点一直是磁共振扩散分析，但该软件本身的设计是为了与尽可能广泛的应用程序兼容。
代码库目前是稳定的，我们没有计划开始一个新的主要版本或弃用该API的大部分。
我们邀请开发人员将我们的软件框架用于新的应用程序，并鼓励研究人员考虑在他们的工作中使用MRtrix3，无论是专注于扩散磁共振成像还是其他成像模式。这项工作主要得到澳大利亚国家健康和医学研究委员会(NHMRC)的支持(计划拨款400121,628952,1091593；AC研究奖学金1026077)。
我们还感谢维多利亚州政府的运营基础设施支持计划的支持。这项工作还获得了欧洲研究理事会根据欧盟第七框架计划(FP7/2007-2013/ERC赠款协议编号)的资助。
[319456]项目)，并得到伦敦国王学院惠康/EPSRC医学工程中心[WT 203148/Z/16/Z]、专题医学研究理事会[MR/K006355/1]以及设在盖伊和圣托马斯国民保健服务基金会信托基金的国家卫生研究所生物医学研究中心和伦敦国王学院的支持。
本文仅代表作者的观点，不一定是NHS、NIHR或卫生部的观点。RS最近得到了澳大利亚政府国家合作研究基础设施战略(NCRIS)能力国家成像设施(NIF)的奖学金资助。BJ是佛兰德斯研究基金会(FWOVlaanderen)的博士后研究员，批准号为12M3116N和12M3119N

图像数据可以通过多种方式存储在文件或RAM中。
实质上，多维图像数据由每个位置的一个值组成，由坐标x、y、z……索引。前3个坐标通常指的是沿空间x、y、z轴的体素索引，更高的索引指的是单独的体积或其任何合理的索引。
然而，当存储在文件或RAM中时，数据将线性排列，并通过单个偏移量进行索引。
需要一种策略来通过将体素坐标映射到文件(或存储器)偏移量来管理对数据的访问。为了说明这个问题，考虑存储Densem，n矩阵的元素的问题。
在许多线性代数软件包中，矩阵是以所谓的列为主的格式存储的：第一列的每个元素紧跟在另一个元素之后，直到该列的末尾，然后是下一列的元素，依此类推。
假定这种存储约定，沿列方向相邻的元素被存储在RAM(或文件)中的相邻偏移量处，而沿行方向相邻的元素被放置在至少mElement之间。
因此，(i，j)处的元素相对于索引零处的元素处于偏移量。
这对应于[1M]的步长：沿列方向查找下一个元素的步骤需要步长为1个元素，而沿行方向的等价步长需要更大的步长。但是，矩阵也可以(并且通常是)以所谓的主存储格式存储，其中第一行的元素被连续存储，紧随其后的是下一行，依此类推。
在这种情况下，(i，j)处的元素在第j个偏移量1/4处；这对应于[n1]的步长。
请注意，虽然分别以行为主和列为主格式存储的两个矩阵在逻辑上可能是等价的，但它们元素的存储顺序不同，没有理由偏爱一种约定而不是另一种约定。
事实上，许多实现都支持这两种方法，因为这样简单地通过改变步长来获得大矩阵的转置是微不足道的，而不需要对矩阵元素本身进行重新排序。
可以存储图像，沿该轴的所有亮度一个接一个地存储，然后是沿其轴的下一行的强度，然后是沿z轴的下一切片的强度。
对于SIZENX，NY，NZ的图像，这意味着体素(x，y，z)的强度存储在偏移？x？ynx？znxny处；这对应于[1nxnx，NY]的步长。
然而，数据以这种顺序存储并没有特别的原因，事实上不同的数据跨度是常见的。
在许多情况下，不同的图像格式本身采用不同的存储顺序约定，如果管理不当，可能会导致混乱。
此外，步幅还可以通过允许步幅为正，来反映每个轴被映射的方向，例如，从左到右与从右到左的遍历



说明了存储和访问图像数据时步幅的概念。
问题是将体素坐标[xyzv](上框)与单个偏移文件(下框)相关联。
这可以通过许多不同的方式来完成。
在第一种情况下，数据是按照沿着轴的遍历顺序存储的，然后是沿着它们的轴的每一行，然后是沿着Z轴的每个切片，最后是每个卷。
在第二种情况下，订单在x和yax轴之间交换。
最后一种情况说明了卷连续存储的情况，其中数据首先沿着卷轴被遍历，然后是空间轴。9图A1很容易理解到4D的扩展，图A1也说明了卷连续存储的情况，即当沿卷轴的强度具有相邻的偏移量时，跨度为1表示卷索引。
以这种方式存储的数据有时被称为矢量值数据：为每个体素存储的数据不再是单个强度，而是强度的平均值。
一个有意义的例子是当存储彩色图像时：然后将每个像素的红、绿和蓝分量存储在一起是明智的。
然而，这在任何情况下也是有利的，其中数据向量对于每个体素是可用的(例如，给定体素的所有fMRI或DWI强度)，并且这些数据是按每个体素独立处理的(例如，执行模型拟合)。
当数据按照文件(或内存)中的顺序进行处理时，计算机硬件通常执行得最好：这避免了从磁盘读取时的寻道延迟，允许与主系统内存之间的突发传输，利用了CPU的高速缓存预取引擎，并最大限度地利用了板载CPU高速缓存的每一行。
为了支持所有这些不同的存储约定并增强要执行的各种分析的性能，MRtrix3支持对所有支持的格式和RAM中保存的数据进行任意数据跨度

符号步长虽然用于导航体素信息的实际步长是明确的，但它们通常涉及大量数字，并取决于每个轴上的准确图像尺寸。
为了简化指定和报告步幅的过程，MRtrix3引入了符号步幅的概念，这是mrinfo等工具报告的内容。
对于象征性的步幅，步幅的精确值被忽略，重要的是它相对于其他步幅的大小--即它的排名(注意，步幅的符号被保留)。
因此，对于图A1中所示的示例，步幅将报告为

简单构建外部MRtrix3模块，能够利用MRtrix3功能编译/执行命令，而无需对MRtrix3本身进行任何修改；一致的命令行界面，包括在解析阶段检查输入参数的有效性；与库支持的任何图像文件格式的兼容性；简单构建向用户反馈命令进度的终端；与所有MRtrix3命令一致的自动自我文档编制

注意，下面的示例旨在说明框架的使用，并不一定构成要在这里执行的特定操作的推荐解决方案。作为示例应用，下面的代码示例都计算输入4维图像的体积上的体素强度的体素级几何平均值。
这已经可以使用Unix管道，通过以下命令行调用来完成

此清单包含用于计算图像沿体积尺寸的体素几何平均值的柱代码，可选地将任何非有限输出强度设置为用户指定的值。
此文件的最新电子版本可从MRtrix3资源库40终端使用在线获得。该清单显示了为构建和执行上述代码的应用程序而调用的命令。
这假设代码样本已经保存到名为‘demo_binary.cpp’的文件中，该文件目前位于user’s‘Downloads’folder.40https://github.com/MRtrix3/MRtrix3_demo_code/blob/master/cmd/demo_binary.cpp.J.-D.Tournier等人的NeuroImage202(2019