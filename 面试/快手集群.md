

# 一.机房

Region: 地域，快手现在只有华北区域

AZ（Avaiable Zone）：一个 Region 内的多个逻辑机房，AZ 的多活类似于同城多活【在同一个 Region 的多个 AZ 之间部署你的服务或应用，就像在一个城市内的多个数据中心同时部署服务一样】

DC：物理机房

HB1:华北 1，分为 ZW 和 YZ，后面又分为 AZ1,AZ2,AZ3,AZ4

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250321220318466.png" alt="image-20250321220318466" style="zoom: 33%;" />



所有流量闭环在一个 AZ 中，如果涉及到 mysql 主从，主库在 ZW，假如是从 YZ 发起的请求，则必须跨 AZ 去写

读流量则都在一个 AZ 内闭环，跨机房访问网络流量会比较大



<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250321220615799.png" alt="image-20250321220615799" style="zoom: 50%;" />



**BFF（Backend for Frontend）服务器** 是为特定前端界面（如 Web、移动端、小程序）量身定制的后端服务。

它作为前端与后端核心系统之间的 **中间层**，负责处理和整合后端服务数据，为前端提供“刚好合适”的接口。

1. **数据裁剪和聚合：** 从多个后端服务拉取数据，按需整理为前端需要的格式；
2. **接口定制：** 为不同前端（Web、iOS、Android）提供个性化接口；
3. **性能优化：** 缓存、降级处理、合并请求；
4. **安全控制：** 统一处理认证、鉴权、参数校验等逻辑；
5. **解耦前后端开发：** 前端团队可独立管理自己的后端逻辑。



不同的域名规则：服务端基于用户 ip 或 id 进行哈希，下发相应的域名，ip 的规则侧重于机房的流量均匀性

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250321222407604.png" alt="image-20250321222407604" style="zoom:50%;" />



redis 主从架构，两种方式 热备和冷备

热备：主从都能读

冷备：主可以读写，从只用来备份

对于计数器这种读敏感的场景，只适合用冷备的方式



<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324093159224.png" alt="image-20250324093159224" style="zoom:50%;" />





<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324093251275.png" alt="image-20250324093251275" style="zoom:50%;" />

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324093524457.png" alt="image-20250324093524457" style="zoom:50%;" />

PipeLine 失败会报错，典型场景，视频的热评只会维护十个，多了的再remov，可以用pipline去执行





<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324095421560.png" alt="image-20250324095421560" style="zoom:50%;" />

redis 集群节点数量有限制，所以采用代理的模式





<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324100315807.png" alt="image-20250324100315807" style="zoom:50%;" />

每次先预售，如果超卖了再加回来，多写一次来达到加锁的目的

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324100821879.png" alt="image-20250324100821879" style="zoom:50%;" />



<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324102513233.png" alt="image-20250324102513233" style="zoom:50%;" />





<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324102722895.png" alt="image-20250324102722895" style="zoom:50%;" />

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324112323499.png" alt="image-20250324112323499" style="zoom:50%;" />

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324112406940.png" alt="image-20250324112406940" style="zoom:50%;" />



数据量小，流量大 -》本地缓存

数据量大，流量大-〉分布式缓存【热key-》本地缓存或者拆分】

热key：

检测：1。提前根据业务进行计算 2.计算不出来的话，例如流量投放的场景，固定在12点进行流量投放，通过一个组件计算某一时间某个key访问的次数1ms流量达到20，然后扔进kafka，consumer计算一段时间窗口流量是否过高，然后将其放入本地缓存中。

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324113026753.png" alt="image-20250324113026753" style="zoom:50%;" />



<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324133444767.png" alt="image-20250324133444767" style="zoom:50%;" />



<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324133600069.png" alt="image-20250324133600069" style="zoom:50%;" />

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324133648345.png" alt="image-20250324133648345" style="zoom:50%;" />

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324133936089.png" alt="image-20250324133936089" style="zoom:50%;" />

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324134022141.png" alt="image-20250324134022141" style="zoom:50%;" />

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324134141936.png" alt="image-20250324134141936" style="zoom:50%;" />



<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324134259467.png" alt="image-20250324134259467" style="zoom:50%;" />

<img src="/Users/moon/Library/Application Support/typora-user-images/image-20250324134353041.png" alt="image-20250324134353041" style="zoom:50%;" />
